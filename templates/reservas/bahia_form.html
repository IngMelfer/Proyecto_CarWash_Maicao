{% extends 'base.html' %}

{% block title %}{{ titulo }} - Premium Car Detailing{% endblock %}

{% block extra_css %}
<style>
    .dashboard-header {
        background-color: #343a40;
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
    }
    .form-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .form-group {
        margin-bottom: 20px;
    }
    .form-check {
        padding-left: 2rem;
    }
    .camera-options {
        padding: 15px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header">
    <div class="container">
        <h1>{{ titulo }}</h1>
    </div>
</div>

<div class="container">
    <div class="form-container">
        <form method="post">
            {% csrf_token %}
            
            {% if form.errors %}
                <div class="alert alert-danger">
                    <strong>Error:</strong> Por favor corrija los errores indicados a continuación.
                </div>
            {% endif %}
            
            <div class="form-group">
                <label for="{{ form.nombre.id_for_label }}" class="form-label">Nombre:</label>
                {{ form.nombre }}
                {% if form.nombre.errors %}
                    <div class="text-danger">{{ form.nombre.errors }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.descripcion.id_for_label }}" class="form-label">Descripción:</label>
                {{ form.descripcion }}
                {% if form.descripcion.errors %}
                    <div class="text-danger">{{ form.descripcion.errors }}</div>
                {% endif %}
            </div>
            
            <div class="form-group form-check">
                {{ form.activo }}
                <label for="{{ form.activo.id_for_label }}" class="form-check-label">Activo</label>
                {% if form.activo.errors %}
                    <div class="text-danger">{{ form.activo.errors }}</div>
                {% endif %}
            </div>
            
            <div class="form-group form-check">
                {{ form.tiene_camara }}
                <label for="{{ form.tiene_camara.id_for_label }}" class="form-check-label">Tiene Cámara Web</label>
                {% if form.tiene_camara.errors %}
                    <div class="text-danger">{{ form.tiene_camara.errors }}</div>
                {% endif %}
            </div>
            
            <div class="camera-options" id="camera-options">
                <div class="form-group mb-3" id="tipo_camara_container">
                    <label for="{{ form.tipo_camara.id_for_label }}" class="form-label">{{ form.tipo_camara.label }}</label>
                    {{ form.tipo_camara }}
                    <div class="form-text text-muted">Seleccione el tipo de aplicación de cámara que utilizará.</div>
                    {% if form.tipo_camara.errors %}
                        <div class="text-danger">{{ form.tipo_camara.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.ip_camara.id_for_label }}" class="form-label">IP de la Cámara (Local):</label>
                    {{ form.ip_camara }}
                    <small class="form-text text-muted">{{ form.ip_camara.help_text }}</small>
                    {% if form.ip_camara.errors %}
                        <div class="text-danger">{{ form.ip_camara.errors }}</div>
                    {% endif %}
                </div>
                
                <!-- Configuración de Producción -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-cloud"></i> Configuración para Producción (PythonAnywhere)</h6>
                    </div>
                    <div class="card-body">
                        <div class="form-group form-check mb-3">
                            {{ form.activa_produccion }}
                            <label for="{{ form.activa_produccion.id_for_label }}" class="form-check-label">Activar configuración de producción</label>
                            <small class="form-text text-muted d-block">{{ form.activa_produccion.help_text }}</small>
                            {% if form.activa_produccion.errors %}
                                <div class="text-danger">{{ form.activa_produccion.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div id="produccion-fields" style="display: none;">
                            <div class="form-group mb-3">
                                <label for="{{ form.ip_publica.id_for_label }}" class="form-label">IP Pública o Dominio:</label>
                                {{ form.ip_publica }}
                                <small class="form-text text-muted">{{ form.ip_publica.help_text }}</small>
                                {% if form.ip_publica.errors %}
                                    <div class="text-danger">{{ form.ip_publica.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="form-group mb-3">
                                <label for="{{ form.puerto_externo.id_for_label }}" class="form-label">Puerto Externo:</label>
                                {{ form.puerto_externo }}
                                <small class="form-text text-muted">{{ form.puerto_externo.help_text }}</small>
                                {% if form.puerto_externo.errors %}
                                    <div class="text-danger">{{ form.puerto_externo.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.usuario_camara.id_for_label }}" class="form-label">Usuario de la Cámara:</label>
                                        {{ form.usuario_camara }}
                                        <small class="form-text text-muted">{{ form.usuario_camara.help_text }}</small>
                                        {% if form.usuario_camara.errors %}
                                            <div class="text-danger">{{ form.usuario_camara.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.password_camara.id_for_label }}" class="form-label">Contraseña de la Cámara:</label>
                                        {{ form.password_camara }}
                                        <small class="form-text text-muted">{{ form.password_camara.help_text }}</small>
                                        {% if form.password_camara.errors %}
                                            <div class="text-danger">{{ form.password_camara.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group form-check mb-3">
                                {{ form.usar_ssl }}
                                <label for="{{ form.usar_ssl.id_for_label }}" class="form-check-label">Usar HTTPS/SSL</label>
                                <small class="form-text text-muted d-block">{{ form.usar_ssl.help_text }}</small>
                                {% if form.usar_ssl.errors %}
                                    <div class="text-danger">{{ form.usar_ssl.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="alert alert-warning">
                                <h6><i class="fas fa-exclamation-triangle"></i> Configuración para PythonAnywhere</h6>
                                <p class="mb-2">Para que la cámara funcione en producción, necesita:</p>
                                <ul class="mb-0">
                                    <li><strong>IP Pública:</strong> Configure su router para tener una IP pública estática o use un servicio de DNS dinámico</li>
                                    <li><strong>Port Forwarding:</strong> Configure su router para redirigir el puerto externo al puerto interno de la cámara</li>
                                    <li><strong>Firewall:</strong> Asegúrese de que el puerto esté abierto en su firewall</li>
                                    <li><strong>Alternativa:</strong> Use un túnel seguro como ngrok o similar</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info mt-3">
                    <h6><i class="fas fa-info-circle"></i> Opciones de configuración de cámaras</h6>
                    
                    <ul class="nav nav-tabs" id="cameraTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="ip-webcam-tab" data-bs-toggle="tab" data-bs-target="#ip-webcam" type="button" role="tab" aria-controls="ip-webcam" aria-selected="true">IP Webcam</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="droidcam-tab" data-bs-toggle="tab" data-bs-target="#droidcam" type="button" role="tab" aria-controls="droidcam" aria-selected="false">DroidCam</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="iriun-tab" data-bs-toggle="tab" data-bs-target="#iriun" type="button" role="tab" aria-controls="iriun" aria-selected="false">Iriun Webcam</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="other-tab" data-bs-toggle="tab" data-bs-target="#other" type="button" role="tab" aria-controls="other" aria-selected="false">Otras cámaras</button>
                        </li>
                    </ul>
                    
                    <div class="tab-content pt-3" id="cameraTabsContent">
                        <!-- IP Webcam (Android) -->
                        <div class="tab-pane fade show active" id="ip-webcam" role="tabpanel" aria-labelledby="ip-webcam-tab">
                            <p>Para usar <strong>IP Webcam</strong> (recomendado para Android):</p>
                            <ol>
                                <li>Instale la aplicación <strong>IP Webcam</strong> desde Google Play Store.</li>
                                <li>Asegúrese de que su dispositivo y este servidor estén en la misma red WiFi.</li>
                                <li>Abra la aplicación y toque "Iniciar servidor".</li>
                                <li>Anote la dirección IP que muestra la aplicación (ejemplo: 192.168.1.100:8080).</li>
                                <li>En este formulario, ingrese la dirección IP y puerto en el formato: <code>192.168.1.100:8080/video</code></li>
                            </ol>
                            <p class="mb-0"><strong>Ventajas:</strong> Más estable que DroidCam, opciones avanzadas de configuración, compatible con la mayoría de navegadores.</p>
                        </div>
                        
                        <!-- DroidCam -->
                        <div class="tab-pane fade" id="droidcam" role="tabpanel" aria-labelledby="droidcam-tab">
                            <p>Para usar <strong>DroidCam</strong>:</p>
                            <ol>
                                <li>Instale la aplicación <strong>DroidCam</strong> en su dispositivo Android.</li>
                                <li>Asegúrese de que su dispositivo y este servidor estén en la misma red WiFi.</li>
                                <li>Abra la aplicación DroidCam en su dispositivo.</li>
                                <li>Anote la dirección IP y el puerto (ejemplo: 192.168.1.100:4747).</li>
                                <li>En este formulario, ingrese la dirección IP y puerto en el formato: <code>192.168.1.100:4747</code></li>
                            </ol>
                            <p class="mb-0"><strong>Nota:</strong> Si experimenta problemas de conexión con DroidCam, considere usar IP Webcam como alternativa.</p>
                        </div>
                        
                        <!-- Iriun Webcam -->
                        <div class="tab-pane fade" id="iriun" role="tabpanel" aria-labelledby="iriun-tab">
                            <p>Para usar <strong>Iriun Webcam</strong> (compatible con Android e iOS):</p>
                            <ol>
                                <li>Instale la aplicación <strong>Iriun Webcam</strong> en su dispositivo móvil.</li>
                                <li>Instale el cliente <a href="https://iriun.com" target="_blank">Iriun Webcam</a> en su computadora.</li>
                                <li>Asegúrese de que su dispositivo y este servidor estén en la misma red WiFi.</li>
                                <li>Abra la aplicación en su dispositivo y el cliente en su computadora.</li>
                                <li>En este formulario, ingrese la dirección IP del servidor donde se ejecuta el cliente Iriun.</li>
                            </ol>
                            <p class="mb-0"><strong>Ventajas:</strong> Compatible con iOS y Android, alta calidad de video, baja latencia.</p>
                        </div>
                        
                        <!-- Otras cámaras -->
                        <div class="tab-pane fade" id="other" role="tabpanel" aria-labelledby="other-tab">
                            <p>Para usar <strong>otras cámaras IP</strong>:</p>
                            <ul>
                                <li><strong>Cámaras IP estándar:</strong> Ingrese la dirección IP completa, incluyendo protocolo (http:// o rtsp://).</li>
                                <li><strong>Cámaras RTSP:</strong> Use el formato <code>rtsp://usuario:contraseña@192.168.1.100/stream</code></li>
                                <li><strong>Cámaras HTTP:</strong> Use el formato <code>http://192.168.1.100/video</code></li>
                            </ul>
                            <p class="mb-0"><strong>Nota:</strong> Consulte la documentación de su cámara para obtener la URL exacta.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Botón para probar conectividad -->
            <div class="form-group">
                <button type="button" id="probar-camara-btn" class="btn btn-info btn-sm">
                    <i class="fas fa-wifi"></i> Probar Conectividad
                </button>
                <div id="resultado-prueba" class="mt-2"></div>
            </div>
            
            <div class="mt-4 d-flex justify-content-between">
                <a href="{% url 'reservas:bahia_list' %}" class="btn btn-secondary">Cancelar</a>
                <button type="submit" class="btn btn-primary">Guardar</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tieneCamaraCheckbox = document.getElementById('{{ form.tiene_camara.id_for_label }}');
        const cameraOptions = document.getElementById('camera-options');
        const tipoCamaraContainer = document.getElementById('tipo_camara_container');
        const probarCamaraBtn = document.getElementById('probar-camara-btn');
        const resultadoPrueba = document.getElementById('resultado-prueba');
        
        // Función para mostrar/ocultar opciones de cámara
        function toggleCameraOptions() {
            if (tieneCamaraCheckbox.checked) {
                cameraOptions.style.display = 'block';
                tipoCamaraContainer.style.display = 'block';
            } else {
                cameraOptions.style.display = 'none';
                tipoCamaraContainer.style.display = 'none';
            }
        }
        
        // Inicializar estado
        toggleCameraOptions();
        
        // Escuchar cambios en el checkbox
        tieneCamaraCheckbox.addEventListener('change', toggleCameraOptions);
        
        // Manejar la visibilidad de los campos de producción
        const activaProduccionCheckbox = document.getElementById('{{ form.activa_produccion.id_for_label }}');
        const produccionFields = document.getElementById('produccion-fields');
        
        function toggleProduccionFields() {
            if (activaProduccionCheckbox && activaProduccionCheckbox.checked) {
                produccionFields.style.display = 'block';
            } else {
                produccionFields.style.display = 'none';
            }
        }
        
        // Inicializar estado de campos de producción
        if (activaProduccionCheckbox) {
            toggleProduccionFields();
            activaProduccionCheckbox.addEventListener('change', toggleProduccionFields);
        }
        
        // Actualizar el placeholder del campo IP según el tipo de cámara seleccionado
        const tipoCamaraSelect = document.getElementById('{{ form.tipo_camara.id_for_label }}');
        const ipCamaraInput = document.getElementById('{{ form.ip_camara.id_for_label }}');
        
        function updateIpCamaraPlaceholder() {
            const selectedType = tipoCamaraSelect.value;
            
            switch(selectedType) {
                case 'droidcam':
                    ipCamaraInput.placeholder = 'Ejemplo: 192.168.1.100:4747';
                    break;
                case 'ipwebcam':
                    ipCamaraInput.placeholder = 'Ejemplo: 192.168.1.100:8080/video';
                    break;
                case 'iriun':
                    ipCamaraInput.placeholder = 'Ejemplo: 192.168.1.100:8080';
                    break;
                case 'rtsp':
                    ipCamaraInput.placeholder = 'Ejemplo: rtsp://usuario:contraseña@192.168.1.100/stream';
                    break;
                case 'http':
                    ipCamaraInput.placeholder = 'Ejemplo: http://192.168.1.100/video.mjpg';
                    break;
                default:
                    ipCamaraInput.placeholder = 'Dirección IP o URL de la cámara';
            }
        }
        
        // Función para probar conectividad de la cámara
        function probarConectividad() {
            const formData = {
                tipo_camara: tipoCamaraSelect.value,
                ip_camara: ipCamaraInput.value,
                ip_publica: document.getElementById('{{ form.ip_publica.id_for_label }}').value,
                puerto_externo: document.getElementById('{{ form.puerto_externo.id_for_label }}').value,
                usuario_camara: document.getElementById('{{ form.usuario_camara.id_for_label }}').value,
                password_camara: document.getElementById('{{ form.password_camara.id_for_label }}').value,
                usar_ssl: document.getElementById('{{ form.usar_ssl.id_for_label }}').checked,
                activa_produccion: activaProduccionCheckbox.checked
            };

            // Mostrar indicador de carga
            probarCamaraBtn.disabled = true;
            probarCamaraBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Probando...';
            resultadoPrueba.innerHTML = '';

            // Realizar petición AJAX
            fetch('{% url "reservas:probar_conectividad_camara" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                let alertClass = data.success ? 'alert-success' : 'alert-danger';
                let icon = data.success ? 'fa-check-circle' : 'fa-exclamation-triangle';
                
                let html = `
                    <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                        <i class="fas ${icon}"></i> ${data.message}
                        ${data.url ? `<br><small><strong>URL:</strong> ${data.url}</small>` : ''}
                        ${data.note ? `<br><small><strong>Nota:</strong> ${data.note}</small>` : ''}
                        <button type="button" class="close" data-dismiss="alert">
                            <span>&times;</span>
                        </button>
                    </div>
                `;
                
                resultadoPrueba.innerHTML = html;
            })
            .catch(error => {
                resultadoPrueba.innerHTML = `
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="fas fa-exclamation-triangle"></i> Error al probar la conectividad: ${error.message}
                        <button type="button" class="close" data-dismiss="alert">
                            <span>&times;</span>
                        </button>
                    </div>
                `;
            })
            .finally(() => {
                probarCamaraBtn.disabled = false;
                probarCamaraBtn.innerHTML = '<i class="fas fa-wifi"></i> Probar Conectividad';
            });
        }
        
        // Inicializar el placeholder
        if (tipoCamaraSelect) {
            updateIpCamaraPlaceholder();
            
            // Escuchar cambios en el tipo de cámara
            tipoCamaraSelect.addEventListener('change', updateIpCamaraPlaceholder);
        }
        
        // Event listener para el botón de probar conectividad
        if (probarCamaraBtn) {
            probarCamaraBtn.addEventListener('click', probarConectividad);
        }
    });
</script>
{% endblock %}