{% extends 'base.html' %}
{% load static %}

{% block title %}Reservar Turno - Premium Car Detailing{% endblock %}

{% block extra_css %}
<style>
    .service-card {
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .service-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .service-card.border-primary {
        border: 2px solid #0d6efd !important;
        background-color: #f8f9ff;
    }
    
    .reservation-step {
        display: none;
    }
    
    .reservation-step.active {
        display: block;
    }
    
    .step-indicator {
        background-color: #e9ecef;
        color: #6c757d;
    }
    
    .step-indicator.active {
        background-color: #0d6efd;
        color: white;
    }
    
    .horario-card, .bahia-card, .lavador-card {
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .horario-card:hover, .bahia-card:hover, .lavador-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .rating {
        color: #ffc107;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <!-- Menú lateral -->
        <div class="col-md-3 mb-4">
            <div class="card shadow">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Mi Cuenta</h5>
                </div>
                <div class="list-group list-group-flush">
                    <a href="{% url 'autenticacion:perfil' %}" class="list-group-item list-group-item-action">
                        <i class="fas fa-user-circle me-2"></i> Mi Perfil
                    </a>
                    {% if not user.is_staff %}
                    <a href="{% url 'reservas:mis_turnos' %}" class="list-group-item list-group-item-action active">
                        <i class="fas fa-calendar-alt me-2"></i> Mis Turnos
                    </a>
                    <a href="{% url 'clientes:historial_servicios' %}" class="list-group-item list-group-item-action">
                        <i class="fas fa-history me-2"></i> Historial de Servicios
                    </a>
                    <a href="{% url 'clientes:puntos_recompensas' %}" class="list-group-item list-group-item-action">
                        <i class="fas fa-star me-2"></i> Puntos y Recompensas
                    </a>
                    {% endif %}
                    <a href="{% url 'autenticacion:logout' %}" class="list-group-item list-group-item-action text-danger">
                        <i class="fas fa-sign-out-alt me-2"></i> Cerrar Sesión
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Contenido principal -->
        <div class="col-md-9">
            <div class="card shadow">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Reservar Turno</h4>
                </div>
                <div class="card-body">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                    
                    <form method="post" id="reservaForm" novalidate>
                        {% csrf_token %}
                        <input type="hidden" name="bahia_id" id="bahiaInput">
                        <!-- Campo oculto para depurar -->
                        <input type="hidden" name="debug_info" id="debugInfo" value="">
                        
                        <!-- Paso 1: Selección de Servicio -->
                        <div class="reservation-step active" id="step1">
                            <h5 class="border-bottom pb-2 mb-4">Paso 1: Selecciona el Servicio</h5>
                            
                            <div class="row row-cols-1 row-cols-md-3 g-4 mb-4">
                                {% for servicio in servicios %}
                                <div class="col">
                                    <div class="card h-100 service-card" data-service-id="{{ servicio.id }}">
                                        <div class="card-body">
                                            <h5 class="card-title">{{ servicio.nombre }}</h5>
                                            <p class="card-text">{{ servicio.descripcion }}</p>
                                            <p class="card-text"><strong>Duración:</strong> {{ servicio.duracion_minutos }} minutos</p>
                                            <p class="card-text"><strong>Precio:</strong> ${{ servicio.precio }}</p>
                                        </div>
                                        <div class="card-footer bg-transparent">
                                            <div class="form-check">
                                                <input class="form-check-input service-radio" type="radio" name="servicio" id="servicio{{ servicio.id }}" value="{{ servicio.id }}">
                                                <label class="form-check-label" for="servicio{{ servicio.id }}">
                                                    Seleccionar
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <div class="d-flex justify-content-end mt-4">
                                <button type="button" class="btn btn-primary" id="nextToStep2">
                                    Siguiente <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Paso 2: Selección de Fecha y Hora -->
                        <div class="reservation-step" id="step2" style="display: none;">
                            <h5 class="border-bottom pb-2 mb-4">Paso 2: Selecciona Fecha y Hora</h5>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <label for="fecha" class="form-label">Fecha</label>
                                    <input type="date" class="form-control" id="fecha" name="fecha" required>
                                </div>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <label class="form-label">Horarios Disponibles</label>
                                    <div id="horariosDisponibles" class="d-flex flex-wrap gap-2">
                                        <div class="alert alert-info w-100">
                                            Selecciona una fecha para ver los horarios disponibles.
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary" id="backToStep1">
                                    <i class="fas fa-arrow-left me-2"></i> Anterior
                                </button>
                                <button type="button" class="btn btn-primary" id="nextToStep3">
                                    Siguiente <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Paso 3: Información del Vehículo -->
        <div class="reservation-step" id="step3" style="display: none;">
            <h5 class="border-bottom pb-2 mb-4">Paso 3: Información del Vehículo</h5>
            
            <!-- Selección de vehículo existente -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <label for="vehiculo" class="form-label">Seleccionar vehículo existente</label>
                    <select class="form-select" id="vehiculo" name="vehiculo">
                        <option value="" selected>-- Seleccionar vehículo o ingresar uno nuevo --</option>
                        {% for vehiculo in vehiculos %}
                            <option value="{{ vehiculo.id }}">{{ vehiculo.marca }} {{ vehiculo.modelo }} ({{ vehiculo.placa }})</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div id="nuevoVehiculoForm">
                <h6 class="mb-3">O ingresa un nuevo vehículo</h6>
                
                <div class="row mb-3">
                    <div class="col-md-6 mb-3">
                        <label for="marca" class="form-label">Marca</label>
                        <input type="text" class="form-control" id="marca" name="marca">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="modelo" class="form-label">Modelo</label>
                        <input type="text" class="form-control" id="modelo" name="modelo">
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6 mb-3">
                        <label for="anio" class="form-label">Año</label>
                        <input type="number" class="form-control" id="anio" name="anio" min="1900" max="2099">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="placa" class="form-label">Placa</label>
                        <input type="text" class="form-control" id="placa" name="placa">
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6 mb-3">
                        <label for="tipo_vehiculo" class="form-label">Tipo de Vehículo</label>
                        <select class="form-select" id="tipo_vehiculo" name="tipo_vehiculo">
                            <option value="" disabled selected>Seleccione...</option>
                            <option value="AU">Automóvil</option>
                            <option value="CA">Camioneta</option>
                            <option value="SU">SUV</option>
                            <option value="MO">Motocicleta</option>
                            <option value="OT">Otro</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="color" class="form-label">Color</label>
                        <input type="text" class="form-control" id="color" name="color">
                    </div>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-12">
                    <label for="observaciones" class="form-label">Observaciones (opcional)</label>
                    <textarea class="form-control" id="observaciones" name="observaciones" rows="3" placeholder="Indique cualquier detalle importante sobre su vehículo o el servicio que necesita"></textarea>
                </div>
            </div>
                            
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary" id="backToStep2">
                                    <i class="fas fa-arrow-left me-2"></i> Anterior
                                </button>
                                <button type="button" class="btn btn-primary" id="nextToStep4">
                                    Siguiente <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Paso 4: Selección de Bahía -->
                        <div class="reservation-step" id="step4" style="display: none;">
                            <h5 class="border-bottom pb-2 mb-4">Paso 4: Selecciona tu Bahía</h5>
                            
                            <div class="alert alert-info mb-4">
                                <i class="fas fa-info-circle me-2"></i> Selecciona la bahía donde deseas que se realice tu servicio. Las bahías con cámara te permiten ver tu vehículo durante el proceso.
                            </div>
                            
                            <div id="bahiasContainer" class="row row-cols-1 row-cols-md-3 g-4 mb-4">
                                <div class="text-center w-100">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando bahías...</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary" id="backToStep3">
                                    <i class="fas fa-arrow-left me-2"></i> Anterior
                                </button>
                                <button type="button" class="btn btn-primary" id="nextToStep5">
                                    Siguiente <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Paso 5: Selección de Lavador -->
                        <div class="reservation-step" id="step5" style="display: none;">
                            <h5 class="border-bottom pb-2 mb-4">Paso 5: Selecciona tu Lavador</h5>
                            
                            <div class="alert alert-info mb-4">
                                <i class="fas fa-info-circle me-2"></i> Selecciona el lavador que deseas que realice tu servicio. Puedes ver su calificación promedio y experiencia.
                            </div>
                            
                            <!-- Campo oculto para almacenar el lavador seleccionado -->
                            <input type="hidden" name="lavador_id" id="lavadorInput">
                            
                            <div id="lavadoresContainer" class="row row-cols-1 row-cols-md-3 g-4 mb-4">
                                {% if lavadores_disponibles %}
                                    {% for lavador in lavadores_disponibles %}
                                        <div class="col">
                                            <div class="card h-100 lavador-card" data-lavador-id="{{ lavador.id }}">
                                                <div class="card-body text-center">
                                                    <div class="lavador-icon mb-3">
                                                        {% if lavador.fotografia %}
                                                            <img src="{{ lavador.fotografia.url }}" alt="{{ lavador.nombre_completo }}" class="rounded-circle" width="80" height="80">
                                                        {% else %}
                                                            <i class="fas fa-user-circle fa-4x text-secondary"></i>
                                                        {% endif %}
                                                    </div>
                                                    <h5 class="card-title">{{ lavador.nombre_completo }}</h5>
                                                    <p class="card-text">{{ lavador.cargo.nombre }}</p>
                                                    <div class="mb-2">
                                                        {% with calificacion=lavador.promedio_calificacion %}
                                                            {% for i in "12345"|make_list %}
                                                                {% if forloop.counter <= calificacion|floatformat:0|add:"0" %}
                                                                    <i class="fas fa-star text-warning"></i>
                                                                {% else %}
                                                                    <i class="far fa-star text-warning"></i>
                                                                {% endif %}
                                                            {% endfor %}
                                                            <span class="ms-1">({{ calificacion|floatformat:1 }})</span>
                                                        {% endwith %}
                                                    </div>
                                                </div>
                                                <div class="card-footer bg-transparent">
                                                    <div class="form-check">
                                                        <input class="form-check-input lavador-radio" type="radio" name="lavador" id="lavador{{ lavador.id }}" value="{{ lavador.id }}">
                                                        <label class="form-check-label" for="lavador{{ lavador.id }}">
                                                            Seleccionar
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="col-12">
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle me-2"></i> No hay lavadores disponibles en este momento. Se asignará uno automáticamente cuando se confirme tu reserva.
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary" id="backToStep5">
                                    <i class="fas fa-arrow-left me-2"></i> Anterior
                                </button>
                                <button type="button" class="btn btn-primary" id="nextToStep6">
                                    Siguiente <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Paso 6: Medio de Pago -->
                        <div class="reservation-step" id="step6" style="display: none;">
                            <h5 class="border-bottom pb-2 mb-4">Paso 6: Seleccionar Medio de Pago</h5>
                            
                            <!-- Sección de puntos disponibles -->
                            {% if request.user.is_authenticated and request.user.cliente %}
                            <div class="card mb-4">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h5 class="mb-1">Puntos disponibles: <span class="badge bg-success">{{ request.user.cliente.saldo_puntos }}</span></h5>
                                            <p class="text-muted mb-0">Puedes usar tus puntos para obtener descuentos o servicios gratuitos</p>
                                        </div>
                                        <div class="d-grid gap-2">
                                            <button type="button" class="btn btn-outline-primary" id="btnRedimirPuntos" data-bs-toggle="modal" data-bs-target="#redimirPuntosModal">
                                                <i class="fas fa-gift me-2"></i> Redimir puntos
                                            </button>
                                            <input type="hidden" id="usarPuntos" name="usar_puntos" value="false">
                                            <input type="hidden" id="puntosARedimir" name="puntos_a_redimir" value="0">
                                            <input type="hidden" id="descuentoAplicado" name="descuento_aplicado" value="0">
                                            <input type="hidden" id="recompensaSeleccionada" name="recompensa_seleccionada" value="">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            <div class="form-group mb-4">
                                <label class="form-label">Medio de Pago</label>
                                
                                <!-- Campo oculto para almacenar el medio de pago seleccionado -->
                                <input type="hidden" id="medioPagoInput" name="medio_pago_hidden">
                                
                                <!-- Contenedor para las tarjetas de medios de pago -->
                                <div id="mediosPagoContainer" class="row row-cols-1 row-cols-md-3 g-4 mt-2">
                                    {% for medio in medios_pago %}
                                        <div class="col">
                                            <div class="card h-100 medio-pago-card" data-medio-id="{{ medio.id }}">
                                                <div class="card-body text-center">
                                                    <div class="medio-pago-icon mb-3">
                                                        <i class="fas fa-qrcode fa-3x text-dark"></i>
                                                    </div>
                                                    <h5 class="card-title">{{ medio.nombre }}</h5>
                                                </div>
                                                <div class="card-footer bg-transparent">
                                                    <div class="form-check">
                                                        <input class="form-check-input medio-pago-radio" type="radio" name="medio_pago" id="medio{{ medio.id }}" value="{{ medio.id }}">
                                                        <label class="form-check-label" for="medio{{ medio.id }}">
                                                            Seleccionar
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                                
                                <div class="mt-3" id="medioPagoSeleccionado" style="display: none;">
                                    <div class="alert alert-success">
                                        <i class="fas fa-check-circle me-2"></i> Medio de pago seleccionado: <strong id="medioPagoNombre"></strong>
                                    </div>
                                </div>
                            </div>
                            
                            <script>
                                // Inicializar el selector de medio de pago con tarjetas y manejar la seleccion de vehiculo
                document.addEventListener('DOMContentLoaded', function() {
                    // Manejar la seleccion de vehiculo
                    const vehiculoSelect = document.getElementById('vehiculo');
                    const nuevoVehiculoForm = document.getElementById('nuevoVehiculoForm');
                    
                    if (vehiculoSelect && nuevoVehiculoForm) {
                        vehiculoSelect.addEventListener('change', function() {
                            if (this.value) {
                                // Si se selecciono un vehiculo existente, ocultar el formulario de nuevo vehiculo
                                nuevoVehiculoForm.style.display = 'none';
                            } else {
                                // Si no se selecciono un vehiculo existente, mostrar el formulario de nuevo vehiculo
                                nuevoVehiculoForm.style.display = 'block';
                            }
                        });
                        
                        // Ejecutar el evento change al cargar la pagina para establecer el estado inicial
                        vehiculoSelect.dispatchEvent(new Event('change'));
                    }
                                    // Asegurarse de que todos los elementos existan
                                    const medioPagoInput = document.getElementById('medioPagoInput');
                                    const medioPagoSeleccionado = document.getElementById('medioPagoSeleccionado');
                                    const medioPagoNombre = document.getElementById('medioPagoNombre');
                                    const medioPagoCards = document.querySelectorAll('.medio-pago-card');
                                    const medioPagoRadios = document.querySelectorAll('.medio-pago-radio');
                                    
                                    console.log('Inicializando selector de medio de pago');
                                    console.log('Tarjetas encontradas:', medioPagoCards.length);
                                    console.log('Radios encontrados:', medioPagoRadios.length);
                                    
                                    // Variable para almacenar el medio de pago seleccionado
                                    let selectedMedioPago = null;
                                    
                                    // Funcion para mostrar el medio de pago seleccionado
                                    function mostrarMedioPagoSeleccionado(medioPagoId, medioPagoText) {
                                        console.log('Seleccionando medio de pago:', medioPagoId, medioPagoText);
                                        if (medioPagoId) {
                                            // Actualizar el campo oculto (solo para compatibilidad)
                                            medioPagoInput.value = medioPagoId;
                                            medioPagoNombre.textContent = medioPagoText;
                                            medioPagoSeleccionado.style.display = 'block';
                                            selectedMedioPago = medioPagoId;
                                            
                                            // Actualizar estilos de todas las tarjetas
                                            medioPagoCards.forEach(card => {
                                                if (parseInt(card.dataset.medioId) === parseInt(medioPagoId)) {
                                                    card.classList.add('border-primary', 'border-3');
                                                    card.classList.add('shadow');
                                                    card.classList.add('selected');
                                                } else {
                                                    card.classList.remove('border-primary', 'border-3');
                                                    card.classList.remove('shadow');
                                                    card.classList.remove('selected');
                                                }
                                            });
                                        }
                                    }
                                    
                                    // Hacer que toda la tarjeta sea clickeable
                                    medioPagoCards.forEach(card => {
                                        // Asegurarse de que la tarjeta tenga el atributo data-medio-id
                                        if (!card.dataset.medioId) {
                                            console.error('Tarjeta sin atributo data-medio-id:', card);
                                            return;
                                        }
                                        
                                        // Hacer que toda la tarjeta sea clickeable
                                        card.style.cursor = 'pointer';
                                        card.style.transition = 'all 0.2s ease-in-out';
                                        
                                        card.addEventListener('click', function(event) {
                                            console.log('Click en tarjeta:', this.dataset.medioId);
                                            const medioPagoId = parseInt(this.dataset.medioId);
                                            const radio = document.querySelector('#medio' + medioPagoId);
                                            
                                            if (radio) {
                                                radio.checked = true;
                                                
                                                // Obtener el nombre del medio de pago
                                                const medioPagoText = this.querySelector('.card-title').textContent.trim();
                                                
                                                // Actualizar UI
                                                mostrarMedioPagoSeleccionado(medioPagoId, medioPagoText);
                                            } else {
                                                console.error('No se encontró el radio button para el medio de pago:', medioPagoId);
                                            }
                                        });
                                        
                                        // Efecto hover
                                        card.addEventListener('mouseenter', function() {
                                            if (!selectedMedioPago || parseInt(this.dataset.medioId) !== parseInt(selectedMedioPago)) {
                                                this.classList.add('border-info');
                                                this.classList.add('shadow-sm');
                                            }
                                        });
                                        
                                        card.addEventListener('mouseleave', function() {
                                            if (!selectedMedioPago || parseInt(this.dataset.medioId) !== parseInt(selectedMedioPago)) {
                                                this.classList.remove('border-info');
                                                this.classList.remove('shadow-sm');
                                            }
                                        });
                                    });
                                    
                                    // Agregar evento de cambio a los radios
                                    medioPagoRadios.forEach(radio => {
                                        radio.addEventListener('change', function() {
                                            console.log('Cambio en radio button:', this.value);
                                            if (this.checked) {
                                                const medioPagoId = parseInt(this.value);
                                                const card = document.querySelector('.medio-pago-card[data-medio-id="' + medioPagoId + '"]');
                                                
                                                if (card) {
                                                    const medioPagoText = card.querySelector('.card-title').textContent.trim();
                                                    
                                                    // Actualizar UI
                                                    mostrarMedioPagoSeleccionado(medioPagoId, medioPagoText);
                                                } else {
                                                    console.error('No se encontró la tarjeta para el medio de pago:', medioPagoId);
                                                }
                                            }
                                        });
                                    });
                                    
                                    // No inicializar automáticamente ningún medio de pago
                                    // El usuario debe seleccionar explícitamente un medio de pago
                                    console.log('Esperando que el usuario seleccione un medio de pago');
                                });
                            </script>
                            
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary" id="backToStep5">
                                    <i class="fas fa-arrow-left me-2"></i> Anterior
                                </button>
                                <button type="button" class="btn btn-primary" id="nextToStep7">
                                    Siguiente <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Paso 7: Confirmación -->
                        <div class="reservation-step" id="step7" style="display: none;">
                            <h5 class="border-bottom pb-2 mb-4">Paso 7: Confirmar Reserva</h5>
                            
                            <div class="card mb-4">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0">Resumen de la Reserva</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <p><strong>Servicio:</strong> <span id="resumen-servicio"></span></p>
                                            <p><strong>Fecha:</strong> <span id="resumen-fecha"></span></p>
                                            <p><strong>Hora:</strong> <span id="resumen-hora"></span></p>
                                            <p><strong>Bahía:</strong> <span id="resumen-bahia"></span></p>
                                <p><strong>Lavador:</strong> <span id="resumen-lavador"></span></p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>Vehículo:</strong> <span id="resumen-vehiculo"></span></p>
                                            <p><strong>Placa:</strong> <span id="resumen-placa"></span></p>
                                            <p><strong>Precio:</strong> <span id="resumen-precio"></span></p>
                                            <p><strong>Medio de Pago:</strong> <span id="resumen-medio-pago"></span></p>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <p><strong>Observaciones:</strong> <span id="resumen-observaciones">-</span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-check mb-4">
                <input class="form-check-input" type="checkbox" id="terminos" name="terminos" required>
                <label class="form-check-label" for="terminos">
                    Acepto los <a href="#" data-bs-toggle="modal" data-bs-target="#terminosModal">Términos y Condiciones</a> del servicio
                </label>
                <div class="invalid-feedback">Debes aceptar los términos y condiciones para continuar.</div>
            </div>
                            
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary" id="backToStep5">
                                    <i class="fas fa-arrow-left me-2"></i> Anterior
                                </button>
                                <button type="submit" class="btn btn-success" id="submitBtn">
                                    <i class="fas fa-check me-2"></i> Confirmar Reserva
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Términos y Condiciones -->
<div class="modal fade" id="terminosModal" tabindex="-1" aria-labelledby="terminosModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="terminosModalLabel">Términos y Condiciones de Reserva</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h5>1. Política de Reservas</h5>
                <p>Al realizar una reserva, usted se compromete a asistir en la fecha y hora programada. Si necesita cancelar o reprogramar su cita, debe hacerlo con al menos 24 horas de anticipación.</p>
                
                <h5>2. Política de Cancelación</h5>
                <p>Las cancelaciones realizadas con menos de 24 horas de anticipación pueden estar sujetas a un cargo por cancelación equivalente al 30% del valor del servicio.</p>
                
                <h5>3. Llegada Tardía</h5>
                <p>Si llega más de 15 minutos tarde a su cita, es posible que debamos reprogramarla para garantizar un servicio de calidad a todos nuestros clientes.</p>
                
                <h5>4. Condiciones del Vehículo</h5>
                <p>Por favor, retire todos los objetos personales de valor de su vehículo antes del servicio. No nos hacemos responsables por objetos perdidos o dañados que hayan sido dejados en el vehículo.</p>
                
                <h5>5. Pago</h5>
                <p>El pago se realizará al finalizar el servicio. Aceptamos efectivo, tarjetas de crédito/débito y transferencias bancarias.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Entendido</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para redimir puntos -->
<div class="modal fade" id="redimirPuntosModal" tabindex="-1" aria-labelledby="redimirPuntosModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="redimirPuntosModalLabel">Redimir Puntos</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="recompensaSelect" class="form-label">Selecciona una recompensa</label>
                    <select class="form-select" id="recompensaSelect" name="recompensa" required>
                        <option value="" selected disabled>Selecciona una opción</option>
                        <option value="descuento_10" data-puntos="100">Descuento 10% (100 puntos)</option>
                        <option value="lavado_basico" data-puntos="200">Lavado Básico Gratis (200 puntos)</option>
                        <option value="detailing_interior" data-puntos="350">Detailing Interior (350 puntos)</option>
                        <option value="lavado_premium" data-puntos="500">Lavado Premium (500 puntos)</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="puntosRedimir" class="form-label">Puntos a redimir</label>
                    <input type="number" class="form-control" id="puntosRedimir" name="puntos" readonly>
                </div>
                <div class="mb-3">
                    <label for="puntosDisponibles" class="form-label">Puntos disponibles</label>
                    <input type="text" class="form-control" id="puntosDisponibles" value="{% if request.user.is_authenticated and request.user.cliente %}{{ request.user.cliente.saldo_puntos }}{% else %}0{% endif %}" readonly>
                </div>
                <div class="alert alert-warning" id="alertaPuntos" style="display: none;">
                    No tienes suficientes puntos para esta recompensa.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnConfirmarRecompensa">Confirmar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Versión: 1.1 - Corrección de navegación entre pasos -->
<style>
    .bahia-card {
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    .bahia-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .bahia-card.border-primary {
        border-color: #0d6efd;
        background-color: rgba(13, 110, 253, 0.05);
    }
    .bahia-icon {
        color: #0d6efd;
    }
</style>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Variables para almacenar la seleccion
        let selectedService = null;
        let selectedDate = null;
        let selectedTime = null;
        let selectedBahia = null;
        let servicePrices = {
            {% for servicio in servicios %}
            {{ servicio.id }}: parseFloat({{ servicio.precio|floatformat:2 }}){% if not forloop.last %},{% endif %}
            {% empty %}
            // No hay servicios disponibles
            {% endfor %}
        };
        let availableBahias = [];
        
        // Seleccion de servicio
        const serviceCards = document.querySelectorAll('.service-card');
        const serviceRadios = document.querySelectorAll('.service-radio');
        
        serviceCards.forEach(card => {
            card.addEventListener('click', function() {
                const serviceId = this.dataset.serviceId;
                const radio = document.querySelector('#servicio' + serviceId);
                radio.checked = true;
                
                // Actualizar estilos
                serviceCards.forEach(c => c.classList.remove('border-primary'));
                this.classList.add('border-primary');
                
                // Guardar seleccion
                selectedService = serviceId;
                
                // Sincronizar con el sistema del archivo JS externo si existe
                if (typeof window.reservaData !== 'undefined') {
                    const servicioNombre = this.querySelector('.card-title').textContent;
                    const servicioPrecio = servicePrices[serviceId];
                    
                    window.reservaData.servicio = serviceId;
                    window.reservaData.servicio_nombre = servicioNombre;
                    window.reservaData.precio = servicioPrecio;
                    
                    // Actualizar resumen si existen los elementos
                    const resumenServicio = document.querySelector('#resumen-servicio');
                    const resumenPrecio = document.querySelector('#resumen-precio');
                    if (resumenServicio) resumenServicio.textContent = servicioNombre;
                    if (resumenPrecio) resumenPrecio.textContent = servicioPrecio;
                }
            });
        });
        
        // Navegacion entre pasos
        const nextToStep2 = document.querySelector('#nextToStep2');
        const backToStep1 = document.querySelector('#backToStep1');
        const nextToStep3 = document.querySelector('#nextToStep3');
        const backToStep2 = document.querySelector('#backToStep2');
        const nextToStep4 = document.querySelector('#nextToStep4');
        const backToStep3 = document.querySelector('#backToStep3');
        const nextToStep5 = document.querySelector('#nextToStep5');
        const backToStep4 = document.querySelector('#backToStep4');
        const nextToStep6 = document.querySelector('#nextToStep6');
        const backToStep5 = document.querySelector('#backToStep5');
        const nextToStep7 = document.querySelector('#nextToStep7');
        const backToStep6 = document.querySelector('#backToStep6');
        
        // Definir el elemento de medio de pago para usarlo en todo el script
        const medioPagoElement = document.querySelector('#medioPago');
        
        // Agregar event listeners solo si los elementos existen
        if (nextToStep2) {
            nextToStep2.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (!selectedService) {
                showAlert('Por favor selecciona un servicio', 'warning');
                return;
            }
            
            document.querySelector('#step1').style.display = 'none';
            document.querySelector('#step2').style.display = 'block';
        });
        }
        
        if (backToStep1) {
            backToStep1.addEventListener('click', function() {
                document.querySelector('#step2').style.display = 'none';
                document.querySelector('#step1').style.display = 'block';
            });
        }
        
        if (nextToStep3) {
            nextToStep3.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (!selectedDate) {
                showAlert('Por favor selecciona una fecha', 'warning');
                return;
            }
            
            if (!selectedTime) {
                showAlert('Por favor selecciona una hora', 'warning');
                return;
            }
            
            document.querySelector('#step2').style.display = 'none';
            document.querySelector('#step3').style.display = 'block';
        });
        }
        
        if (backToStep2) {
            backToStep2.addEventListener('click', function() {
                document.querySelector('#step3').style.display = 'none';
                document.querySelector('#step2').style.display = 'block';
            });
        }
        
        if (nextToStep4) {
            nextToStep4.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Verificar si se seleccionó un vehículo existente
            const vehiculoSelect = document.querySelector('#vehiculo');
            const vehiculoSeleccionado = vehiculoSelect.value;
            
            if (!vehiculoSeleccionado) {
                // Si no se seleccionó un vehículo existente, validar los campos del nuevo vehículo
                const marca = document.querySelector('#marca').value;
                const modelo = document.querySelector('#modelo').value;
                const anio = document.querySelector('#anio').value;
                const placa = document.querySelector('#placa').value;
                const tipo_vehiculo = document.querySelector('#tipo_vehiculo').value;
                const color = document.querySelector('#color').value;
                
                if (!marca || !modelo || !anio || !placa || !tipo_vehiculo || !color) {
                    showAlert('Por favor completa todos los campos obligatorios', 'warning');
                    return;
                }
            }
            
            // Cargar las bahías disponibles para el horario seleccionado
            cargarBahiasDisponibles(selectedDate, selectedTime, selectedService);
            
            document.querySelector('#step3').style.display = 'none';
            document.querySelector('#step4').style.display = 'block';
        });
        }
        
        if (backToStep3) {
            backToStep3.addEventListener('click', function() {
                document.querySelector('#step4').style.display = 'none';
                document.querySelector('#step3').style.display = 'block';
            });
        }
        
        if (nextToStep5) {
            nextToStep5.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (!selectedBahia) {
                showAlert('Por favor selecciona una bahía', 'warning');
                return;
            }
            
            // Cargar los lavadores disponibles para el horario y servicio seleccionado
            cargarLavadoresDisponibles(selectedDate, selectedTime, selectedService);
            
            document.querySelector('#step4').style.display = 'none';
            document.querySelector('#step5').style.display = 'block';
        });
        }
        
        if (backToStep4) {
            backToStep4.addEventListener('click', function() {
                document.querySelector('#step5').style.display = 'none';
                document.querySelector('#step4').style.display = 'block';
            });
        }
        
        // Función para cargar los lavadores disponibles
        function cargarLavadoresDisponibles(fecha, hora, servicioId) {
            const url = '/reservas/obtener_lavadores_disponibles/?fecha=' + fecha + '&hora=' + hora + '&servicio_id=' + servicioId;
            
            fetch(url)
                .then(response => {
                    // Verificar si la respuesta es exitosa
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    // Verificar si el contenido es JSON
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        throw new Error('La respuesta no es JSON válido');
                    }
                    
                    return response.json();
                })
                .then(data => {
                    // Verificar si hay un error en la respuesta
                    if (data.error) {
                        console.error('Error del servidor:', data.error);
                        showAlert('Error al cargar los lavadores disponibles', 'danger');
                        return;
                    }
                    
                    // Verificar si hay lavadores disponibles
                    if (data.lavadores && data.lavadores.length > 0) {
                        // Si ya hay lavadores en el contexto, no necesitamos hacer nada
                        // El template ya los muestra con el bucle for
                        
                        // Agregar evento de selección a las tarjetas de lavadores
                        const lavadorCards = document.querySelectorAll('.lavador-card');
                        const lavadorRadios = document.querySelectorAll('.lavador-radio');
                        let selectedLavador = null;
                        
                        lavadorCards.forEach(card => {
                            card.addEventListener('click', function() {
                                const lavadorId = this.dataset.lavadorId;
                                const radio = document.querySelector('#lavador' + lavadorId);
                                radio.checked = true;
                                
                                // Actualizar estilos
                                lavadorCards.forEach(c => c.classList.remove('border-primary'));
                                this.classList.add('border-primary');
                                
                                // Guardar selección
                                selectedLavador = lavadorId;
                                document.querySelector('#lavadorInput').value = lavadorId;
                            });
                        });
                        
                        lavadorRadios.forEach(radio => {
                            radio.addEventListener('change', function() {
                                if (this.checked) {
                                    const lavadorId = this.value;
                                    
                                    // Actualizar estilos
                                    lavadorCards.forEach(c => c.classList.remove('border-primary'));
                                    document.querySelector('.lavador-card[data-lavador-id="' + lavadorId + '"]').classList.add('border-primary');
                                    
                                    // Guardar selección
                                    selectedLavador = lavadorId;
                                    document.querySelector('#lavadorInput').value = lavadorId;
                                }
                            });
                        });
                    } else {
                        // No hay lavadores disponibles, pero esto no es un error
                        console.log('No hay lavadores disponibles para la fecha y hora seleccionadas');
                        // Opcional: mostrar un mensaje informativo suave
                        // showAlert('No hay lavadores disponibles para la fecha y hora seleccionadas', 'info');
                    }
                })
                .catch(error => {
                    console.error('Error al cargar lavadores:', error);
                    
                    // Proporcionar un mensaje más específico según el tipo de error
                    if (error.message.includes('JSON válido')) {
                        showAlert('Error al cargar lavadores: La respuesta del servidor no es válida. Por favor, verifica tu sesión e intenta nuevamente.', 'danger');
                    } else if (error.message.includes('HTTP error')) {
                        showAlert('Error de conexión al cargar los lavadores disponibles. Por favor, intenta nuevamente.', 'danger');
                    } else {
                        showAlert('Error al cargar los lavadores disponibles. Por favor, intenta nuevamente.', 'danger');
                    }
                });
        }
        
        // Manejar el switch de redimir puntos
        const usarPuntosSwitch = document.querySelector('#usarPuntos');
        const puntosARedimirInput = document.querySelector('#puntosARedimir');
        const descuentoAplicadoInput = document.querySelector('#descuentoAplicado');
        let puntosCliente = 0;
        
        // Obtener los puntos del cliente si está autenticado
        {% if request.user.is_authenticated and request.user.cliente %}
            puntosCliente = parseInt({{ request.user.cliente.saldo_puntos|default:0 }});
        {% else %}
            puntosCliente = 0;
        {% endif %}
        
        // Variable para almacenar el descuento aplicado
        let descuentoAplicado = 0;
        let puntosUsados = 0;
        let precioFinalConDescuento = 0;
        
        if (usarPuntosSwitch) {
            usarPuntosSwitch.addEventListener('change', function() {
                if (this.checked && selectedService) {
                    const precioServicio = servicePrices[selectedService];
                    const resultado = calcularDescuentoPorPuntos(puntosCliente, precioServicio);
                    
                    descuentoAplicado = resultado.descuento;
                    puntosUsados = resultado.puntosUsados;
                    precioFinalConDescuento = resultado.precioFinal;
                    
                    // Actualizar los campos ocultos
                    puntosARedimirInput.value = puntosUsados;
                    descuentoAplicadoInput.value = descuentoAplicado;
                    
                    // Mostrar mensaje con el descuento aplicado
                    const medioPagoSeleccionadoDiv = document.querySelector('#medioPagoSeleccionado');
                    if (medioPagoSeleccionadoDiv) {
                        medioPagoSeleccionadoDiv.style.display = 'block';
                        medioPagoSeleccionadoDiv.innerHTML = `
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i> 
                                <strong>¡Descuento aplicado!</strong> Se redimirán ${puntosUsados} puntos por un valor de $${descuentoAplicado}.
                                ${precioFinalConDescuento === 0 ? '<br><strong>¡Tu servicio será completamente gratis!</strong>' : '<br>Precio final: $' + precioFinalConDescuento}
                            </div>
                        `;
                    }
                } else {
                    // Resetear los valores si se desmarca el switch
                    descuentoAplicado = 0;
                    puntosUsados = 0;
                    precioFinalConDescuento = selectedService ? servicePrices[selectedService] : 0;
                    
                    // Actualizar los campos ocultos
                    puntosARedimirInput.value = 0;
                    descuentoAplicadoInput.value = 0;
                    
                    // Ocultar mensaje de descuento
                    const medioPagoSeleccionadoDiv = document.querySelector('#medioPagoSeleccionado');
                    if (medioPagoSeleccionadoDiv) {
                        medioPagoSeleccionadoDiv.style.display = 'none';
                    }
                }
            });
        }
        
        // Evento para el paso 5 -> 6
        if (nextToStep6) {
            nextToStep6.addEventListener('click', function(e) {
                console.log('Click en nextToStep6 detectado');
                e.preventDefault(); // Evitar que se ejecute la validación del formulario
                e.stopPropagation(); // Evitar que el evento se propague al formulario padre
                
                // Verificar si se seleccionó un lavador
                const lavadorSeleccionado = document.querySelector('input[name="lavador"]:checked');
                let lavadorId = null;
                
                if (lavadorSeleccionado) {
                    lavadorId = lavadorSeleccionado.value;
                    document.querySelector('#lavadorInput').value = lavadorId;
                    console.log('Lavador seleccionado:', lavadorId);
                } else {
                    console.log('No hay lavador seleccionado');
                }
                
                console.log('Cambiando del paso 5 al paso 6');
                document.querySelector('#step5').style.display = 'none';
                document.querySelector('#step6').style.display = 'block';
                
                return false; // Asegurar que no se propague el evento
            });
        } else {
            console.log('nextToStep6 button not found');
        }
        
        // Evento para el paso 6 -> 7 (confirmación)
        if (nextToStep7) {
            nextToStep7.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Validar que se haya seleccionado un medio de pago
                const medioPagoSeleccionado = document.querySelector('input[name="medio_pago"]:checked');
                if (!medioPagoSeleccionado) {
                    showAlert('Por favor selecciona un medio de pago', 'warning');
                    return;
                }
                
                // Marcar automáticamente el checkbox de términos y condiciones
                document.querySelector('#terminos').checked = true;
                
                // Actualizar resumen
                const servicioNombre = document.querySelector('#servicio' + selectedService).closest('.service-card').querySelector('.card-title').textContent;
                document.querySelector('#resumen-servicio').textContent = servicioNombre;
                document.querySelector('#resumen-fecha').textContent = formatDate(selectedDate);
                document.querySelector('#resumen-hora').textContent = selectedTime;
                
                const marca = document.querySelector('#marca').value;
                const modelo = document.querySelector('#modelo').value;
                const anio = document.querySelector('#anio').value;
                const placa = document.querySelector('#placa').value;
                
                document.querySelector('#resumen-vehiculo').textContent = marca + ' ' + modelo + ' ' + anio;
                document.querySelector('#resumen-placa').textContent = placa;
                
                // Mostrar precio con descuento si se aplica
                const precioOriginal = servicePrices[selectedService];
                const usarPuntosValue = document.getElementById('usarPuntos').value;
                const descuentoAplicadoValue = parseFloat(document.getElementById('descuentoAplicado').value) || 0;
                
                if (usarPuntosValue === 'true' && descuentoAplicadoValue > 0) {
                    document.querySelector('#resumen-precio').innerHTML = `
                        <span class="text-decoration-line-through text-muted">$${precioOriginal.toLocaleString()}</span> 
                        <span class="text-success">$${precioFinalConDescuento.toLocaleString()}</span> 
                        <span class="badge bg-success">Descuento: $${descuentoAplicadoValue.toLocaleString()}</span>
                    `;
                } else {
                    document.querySelector('#resumen-precio').textContent = '$' + precioOriginal.toLocaleString();
                }
                
                const observaciones = document.querySelector('#observaciones').value;
                document.querySelector('#resumen-observaciones').textContent = observaciones || '-';
            
            // Añadir información de la bahía seleccionada al resumen
            const bahiaSeleccionada = availableBahias.find(b => b.id === selectedBahia);
            if (bahiaSeleccionada) {
                document.querySelector('#resumen-bahia').innerHTML = bahiaSeleccionada.nombre + ' ' + (bahiaSeleccionada.tiene_camara ? "<span class=\"badge bg-info\"><i class=\"fas fa-video me-1\"></i> Con cámara</span>" : "");
            } else {
                document.querySelector('#resumen-bahia').textContent = 'No seleccionada';
            }
            
            // Añadir información del lavador seleccionado al resumen
            const lavadorId = document.querySelector('#lavadorInput').value;
            if (lavadorId) {
                const lavadorCard = document.querySelector('.lavador-card[data-lavador-id="' + lavadorId + '"]');
                if (lavadorCard) {
                    const nombreLavador = lavadorCard.querySelector('.card-title').textContent;
                    document.querySelector('#resumen-lavador').textContent = nombreLavador;
                } else {
                    document.querySelector('#resumen-lavador').textContent = 'Asignación automática';
                }
            } else {
                document.querySelector('#resumen-lavador').textContent = 'Asignación automática';
            }
            
            // Añadir información del medio de pago al resumen
            const medioPagoCard = document.querySelector(`.medio-pago-card.selected`);
            const medioPagoText = medioPagoCard ? medioPagoCard.querySelector('.card-title').textContent : 'No seleccionado';
            let medioPagoDisplay = medioPagoText;
            
            // Obtener información de la recompensa seleccionada
            // Ya tenemos usarPuntosValue declarado arriba
            const puntosARedimirValue = parseInt(document.getElementById('puntosARedimir').value) || 0;
            const recompensaSeleccionadaValue = document.getElementById('recompensaSeleccionada').value;
            
            // Si se están usando puntos y el precio final es 0, mostrar que se paga con puntos
            if (usarPuntosValue === 'true' && precioFinalConDescuento === 0) {
                medioPagoDisplay = 'Puntos (' + puntosARedimirValue + ' puntos)';
            } else if (usarPuntosValue === 'true' && precioFinalConDescuento > 0) {
                // Obtener el nombre de la recompensa seleccionada
                const recompensaSelect = document.getElementById('recompensaSelect');
                let recompensaNombre = '';
                for (let i = 0; i < recompensaSelect.options.length; i++) {
                    if (recompensaSelect.options[i].value === recompensaSeleccionadaValue) {
                        recompensaNombre = recompensaSelect.options[i].textContent;
                        break;
                    }
                }
                
                medioPagoDisplay = medioPagoText + ' + ' + recompensaNombre + ' (' + puntosARedimirValue + ' puntos)';
            }
            
            document.querySelector('#resumen-medio-pago').textContent = medioPagoDisplay;
            
            // Marcar automáticamente el checkbox de términos y condiciones
            document.querySelector('#terminos').checked = true;
            
            document.querySelector('#step6').style.display = 'none';
            document.querySelector('#step7').style.display = 'block';
        });
        }
        
        if (backToStep5) {
            backToStep5.addEventListener('click', function() {
            document.querySelector('#step6').style.display = 'none';
            document.querySelector('#step5').style.display = 'block';
        });
        }
        
        if (backToStep6) {
            backToStep6.addEventListener('click', function() {
                document.querySelector('#step7').style.display = 'none';
                document.querySelector('#step6').style.display = 'block';
            });
        }
        
        // Manejo de fecha y horarios
        const fechaInput = document.querySelector('#fecha');
        const horariosContainer = document.querySelector('#horariosDisponibles');
        
        // Establecer fecha mínima (hoy)
        const today = new Date();
        fechaInput.min = formatDateValue(today);
        
        // Establecer fecha máxima (30 días después)
        const maxDate = new Date(today);
        maxDate.setDate(maxDate.getDate() + 30);
        if (fechaInput) {
            fechaInput.max = formatDateValue(maxDate);
            
            fechaInput.addEventListener('change', function() {
                selectedDate = this.value;
                cargarHorariosDisponibles(selectedDate, selectedService);
            });
        }
        
        // Función para calcular el descuento por puntos según la recompensa seleccionada
        function calcularDescuentoPorPuntos(puntosCliente, precioServicio, recompensaSeleccionada = null) {
            console.log('Calculando descuento - Puntos cliente:', puntosCliente, 'Precio servicio:', precioServicio, 'Recompensa:', recompensaSeleccionada);
            
            // Si no hay recompensa seleccionada, no se aplica descuento
            if (!recompensaSeleccionada) {
                return {
                    descuento: 0,
                    puntosUsados: 0,
                    precioFinal: precioServicio
                };
            }
            
            // Obtener los puntos necesarios y el descuento según la recompensa seleccionada
            let puntosNecesarios = 0;
            let descuento = 0;
            
            switch (recompensaSeleccionada) {
                case 'descuento_10':
                    puntosNecesarios = 100;
                    descuento = precioServicio * 0.10; // 10% de descuento
                    break;
                case 'lavado_basico':
                    puntosNecesarios = 200;
                    descuento = precioServicio; // 100% de descuento para lavado básico
                    break;
                case 'detailing_interior':
                    puntosNecesarios = 350;
                    descuento = precioServicio; // 100% de descuento para detailing interior
                    break;
                case 'lavado_premium':
                    puntosNecesarios = 500;
                    descuento = precioServicio; // 100% de descuento para lavado premium
                    break;
                default:
                    // Si no se reconoce la recompensa, no se aplica descuento
                    console.log('Recompensa no reconocida');
                    return {
                        descuento: 0,
                        puntosUsados: 0,
                        precioFinal: precioServicio
                    };
            }
            
            // Verificar si el cliente tiene suficientes puntos
            console.log('Verificando puntos - Disponibles:', puntosCliente, 'Necesarios:', puntosNecesarios);
            if (puntosCliente < puntosNecesarios) {
                console.log('Puntos insuficientes');
                return {
                    descuento: 0,
                    puntosUsados: 0,
                    precioFinal: precioServicio
                };
            }
            
            // El cliente tiene suficientes puntos, aplicar descuento
            return {
                descuento: descuento,
                puntosUsados: puntosNecesarios,
                precioFinal: Math.max(0, precioServicio - descuento)
            };
        }
        
        // Función para cargar horarios disponibles
        function cargarHorariosDisponibles(fecha, servicioId) {
            // Mostrar indicador de carga
            horariosContainer.innerHTML = '<div class="text-center w-100"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div></div>';
            
            // Deshabilitar el botón de continuar hasta que se seleccione un horario válido
            const continueButton = document.querySelector('#nextToStep3');
            if (continueButton) {
                continueButton.disabled = true;
            }
            
            // Realizar petición AJAX al servidor usando XMLHttpRequest para evitar conflictos con fetch
            const xhr = new XMLHttpRequest();
            xhr.open('GET', '/reservas/obtener_horarios_disponibles/?fecha=' + fecha + '&servicio_id=' + servicioId, true);
            xhr.setRequestHeader('X-CSRFToken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            const data = JSON.parse(xhr.responseText);
                    // Limpiar contenedor
                    horariosContainer.innerHTML = '';
                    
                    // Verificar si hay error
                    if (data.error) {
                        horariosContainer.innerHTML = '<div class="alert alert-danger w-100">' + data.error + '</div>';
                        // Mostrar mensaje de error en la parte superior del paso 2
                        const errorMsgTop = document.createElement('div');
                        errorMsgTop.className = 'alert alert-danger mb-3';
                        errorMsgTop.textContent = data.error;
                        document.querySelector('#step2').insertBefore(errorMsgTop, document.querySelector('#step2').firstChild);
                        return;
                    }
                    
                    // Eliminar cualquier mensaje de error anterior en la parte superior
                    const prevErrorMsg = document.querySelector('#step2 .alert-danger');
                    if (prevErrorMsg) {
                        prevErrorMsg.remove();
                    }
                    
                    // Mostrar horarios en una lista desplegable
                    if (data.horarios && data.horarios.length > 0) {
                        // Crear el select
                        const selectContainer = document.createElement('div');
                        selectContainer.className = 'form-group w-100';
                        
                        const select = document.createElement('select');
                        select.className = 'form-select time-select';
                        select.id = 'horarioSelect';
                        
                        // Opción por defecto
                        const defaultOption = document.createElement('option');
                        defaultOption.value = '';
                        defaultOption.textContent = 'Seleccione un horario';
                        defaultOption.selected = true;
                        defaultOption.disabled = true;
                        select.appendChild(defaultOption);
                        
                        // Agregar opciones de horarios
                        data.horarios.forEach(horario => {
                            const option = document.createElement('option');
                            option.value = horario.hora_inicio;
                            option.dataset.horaFin = horario.hora_fin; // Guardar la hora de fin para usarla después
                            
                            // Si no está disponible, deshabilitar la opción y mostrar como NO DISPONIBLE
                            if (!horario.disponible) {
                                option.textContent = horario.hora_inicio + ' - NO DISPONIBLE';
                                option.disabled = true;
                                option.className = 'text-danger';
                                option.style.color = 'red';
                            } else {
                                option.textContent = horario.hora_inicio + ' - ' + horario.bahias_disponibles + ' BAHIAS DISPONIBLES';
                            }
                            
                            select.appendChild(option);
                        });
                        
                        // Mostrar el número total de horarios disponibles
                        const horariosDisponibles = data.horarios.filter(horario => horario.disponible).length;
                        const infoHorarios = document.createElement('div');
                        infoHorarios.className = 'mt-2 text-info';
                        infoHorarios.textContent = 'Total de horarios disponibles: ' + horariosDisponibles;
                        
                        // Si hay horarios no disponibles, mostrar un mensaje adicional
                        if (data.horarios.length > horariosDisponibles) {
                            const infoNoDisponibles = document.createElement('div');
                            infoNoDisponibles.className = 'mt-1 text-danger';
                            infoNoDisponibles.textContent = 'Horarios ocupados: ' + (data.horarios.length - horariosDisponibles);
                            selectContainer.appendChild(infoNoDisponibles);
                        }
                        selectContainer.appendChild(infoHorarios);
                        
                        // Evento de cambio
                        select.addEventListener('change', function() {
                            // Guardar selección
                            selectedTime = this.value;
                            // Guardar la hora de fin
                            const selectedOption = this.options[this.selectedIndex];
                            const horaFin = selectedOption.dataset.horaFin;
                            
                            // Asignar el valor al campo oculto de hora
                            const horaInput = document.createElement('input');
                            horaInput.type = 'hidden';
                            horaInput.name = 'hora';
                            horaInput.value = selectedTime;
                            
                            // Eliminar cualquier campo de hora anterior
                            const oldHoraInput = document.querySelector('input[name="hora"]');
                            if (oldHoraInput) {
                                oldHoraInput.remove();
                            }
                            
                            // Agregar el nuevo campo al formulario
                            document.getElementById('reservaForm').appendChild(horaInput);
                            
                            // Limpiar la selección de bahía anterior
                            selectedBahia = null;
                            
                            // Habilitar el botón de continuar
                            if (continueButton) {
                                continueButton.disabled = false;
                            }
                        });
                        
                        selectContainer.appendChild(select);
                        horariosContainer.appendChild(selectContainer);
                    } else {
                        // Mostrar mensaje de alerta más visible cuando no hay horarios disponibles
                        horariosContainer.innerHTML = '<div class="alert alert-warning w-100"><strong>¡Atención!</strong> Para la fecha escogida no hay horarios disponibles. Por favor, seleccione otra fecha.</div>';
                        
                        // Mostrar mensaje de error en la parte superior del paso 2
                        const errorMsgTop = document.createElement('div');
                        errorMsgTop.className = 'alert alert-warning mb-3';
                        errorMsgTop.innerHTML = '<strong>¡Atención!</strong> Para la fecha escogida no hay horarios disponibles. Por favor, seleccione otra fecha.';
                        document.querySelector('#step2').insertBefore(errorMsgTop, document.querySelector('#step2').firstChild);
                    }
                        } catch (e) {
                            console.error('Error parsing JSON:', e);
                            horariosContainer.innerHTML = '<div class="alert alert-danger w-100">Error al procesar la respuesta del servidor.</div>';
                        }
                    } else {
                        console.error('Error HTTP:', xhr.status);
                        horariosContainer.innerHTML = '<div class="alert alert-danger w-100">Error al cargar los horarios disponibles. Por favor, inténtalo de nuevo.</div>';
                    }
                }
            };
            
            xhr.onerror = function() {
                console.error('Error de red');
                horariosContainer.innerHTML = '<div class="alert alert-danger w-100">Error de conexión. Por favor, verifica tu conexión a internet.</div>';
            };
            
            xhr.send();
        }
        
        // Función para cargar bahías disponibles
        function cargarBahiasDisponibles(fecha, hora, servicioId) {
            const bahiasContainer = document.querySelector('#bahiasContainer');
            
            // Mostrar indicador de carga
            bahiasContainer.innerHTML = '<div class="text-center w-100"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando bahías...</span></div></div>';
            
            // Realizar petición AJAX al servidor
            fetch('/reservas/obtener_bahias_disponibles/?fecha=' + fecha + '&hora=' + hora + '&servicio_id=' + servicioId)
                .then(response => response.json())
                .then(data => {
                    // Limpiar contenedor
                    bahiasContainer.innerHTML = '';
                    
                    // Verificar si hay error
                    if (data.error) {
                        bahiasContainer.innerHTML = '<div class="alert alert-danger w-100">' + data.error + '</div>';
                        return;
                    }
                    
                    // Guardar las bahías disponibles (corregido para usar bahias_disponibles)
                    availableBahias = data.bahias_disponibles;
                    
                    // Mostrar bahías en tarjetas visuales
                    if (data.bahias_disponibles && data.bahias_disponibles.length > 0) {
                        data.bahias_disponibles.forEach(bahia => {
                            const bahiaCard = document.createElement('div');
                            bahiaCard.className = 'col';
                            
                            // Crear tarjeta con estilo visual
                            bahiaCard.innerHTML = `
                                <div class="card h-100 bahia-card" data-bahia-id="${bahia.id}">
                                    <div class="card-body text-center">
                                        <div class="bahia-icon mb-3">
                                            <i class="fas fa-car fa-3x"></i>
                                        </div>
                                        <h5 class="card-title">${bahia.nombre}</h5>
                                        <p class="card-text">${bahia.descripcion || 'Sin descripción'}</p>
                                        ${bahia.tiene_camara ? 
                                            '<div class="badge bg-info mb-2"><i class="fas fa-video me-1"></i> Con cámara</div>' : 
                                            '<div class="badge bg-secondary mb-2"><i class="fas fa-video-slash me-1"></i> Sin cámara</div>'
                                        }
                                    </div>
                                    <div class="card-footer bg-transparent">
                                        <div class="form-check">
                                            <input class="form-check-input bahia-radio" type="radio" name="bahia_id" id="bahia${bahia.id}" value="${bahia.id}">
                                            <label class="form-check-label" for="bahia${bahia.id}">
                                                Seleccionar
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            `;
                            
                            bahiasContainer.appendChild(bahiaCard);
                        });
                        
                        // Agregar evento de clic a las tarjetas de bahías
                        const bahiaCards = document.querySelectorAll('.bahia-card');
                        const bahiaRadios = document.querySelectorAll('.bahia-radio');
                        
                        bahiaCards.forEach(card => {
                            card.addEventListener('click', function() {
                                const bahiaId = parseInt(this.dataset.bahiaId);
                                const radio = document.querySelector('#bahia' + bahiaId);
                                radio.checked = true;
                                
                                // Actualizar estilos
                                bahiaCards.forEach(c => c.classList.remove('border-primary'));
                                this.classList.add('border-primary');
                                
                                // Guardar selección
                                selectedBahia = bahiaId;
                                
                                // Actualizar el input hidden
                                document.querySelector('#bahiaInput').value = bahiaId;
                            });
                        });
                        
                        // Agregar evento de cambio a los radio buttons también
                        bahiaRadios.forEach(radio => {
                            radio.addEventListener('change', function() {
                                if (this.checked) {
                                    selectedBahia = parseInt(this.value);
                                    document.querySelector('#bahiaInput').value = this.value;
                                    
                                    // Actualizar estilos visuales
                                    bahiaCards.forEach(c => c.classList.remove('border-primary'));
                                    const selectedCard = document.querySelector(`[data-bahia-id="${this.value}"]`);
                                    if (selectedCard) {
                                        selectedCard.classList.add('border-primary');
                                    }
                                }
                            });
                        });
                    } else {
                        bahiasContainer.innerHTML = '<div class="alert alert-warning w-100">No hay bahías disponibles para el horario seleccionado.</div>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    bahiasContainer.innerHTML = '<div class="alert alert-danger w-100">Error al cargar las bahías disponibles. Por favor, inténtalo de nuevo.</div>';
                });
        }
        
        // Event listener para el formulario de reserva
        const reservaForm = document.querySelector('#reservaForm');
        if (reservaForm) {
            reservaForm.addEventListener('submit', function(e) {
                console.log('Submit del formulario detectado');
                e.preventDefault();
                
                // Obtener el botón de envío y su texto original
                const submitBtn = document.querySelector('#submitBtn');
                const originalBtnText = submitBtn.innerHTML;
                
                // Cambiar el texto del botón y deshabilitarlo
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Procesando...';
                submitBtn.disabled = true;
                
                // Crear FormData con todos los datos del formulario
                const formData = new FormData(reservaForm);
                
                // Verificar que los términos estén aceptados
                if (!document.querySelector('#terminos').checked) {
                    mostrarAlerta('Debe aceptar los términos y condiciones', 'warning');
                    submitBtn.innerHTML = originalBtnText;
                    submitBtn.disabled = false;
                    return;
                }
                
                // La validación del medio de pago ya se hizo en el paso anterior
                
                // Verificar todos los campos requeridos antes de enviar
                const camposRequeridos = ['servicio', 'fecha', 'hora', 'bahia_id'];
                let faltanCampos = false;
                
                // Verificar el resto de campos requeridos
                camposRequeridos.forEach(campo => {
                    if (!formData.has(campo) || !formData.get(campo)) {
                        console.error(`Falta el campo requerido: ${campo}`);
                        faltanCampos = true;
                    }
                });
                
                if (faltanCampos) {
                    mostrarAlerta('Por favor complete todos los campos requeridos', 'warning');
                    submitBtn.innerHTML = originalBtnText;
                    submitBtn.disabled = false;
                    return;
                }
                
                // Enviar el formulario mediante fetch
                fetch(reservaForm.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    redirect: 'follow'
                })
                .then(response => {
                    if (response.redirected) {
                        if (response.url.includes('procesar-pago')) {
                            window.location.href = response.url;
                            return null;
                        }
                    }
                    
                    if (!response.ok) {
                        if (response.status === 401) {
                            throw new Error('SESSION_EXPIRED');
                        }
                        throw new Error(`Error HTTP: ${response.status}`);
                    }
                    
                    return response.text().then(text => {
                        if (!text.trim()) {
                            return {};
                        }
                        try {
                            return JSON.parse(text);
                        } catch (e) {
                            throw new Error('Error al procesar la respuesta del servidor');
                        }
                    });
                })
                .then(data => {
                    if (data === null) return; // Redirección manejada
                    
                    if (data.success) {
                        mostrarAlerta('Reserva creada exitosamente', 'success');
                        setTimeout(() => {
                            window.location.href = data.redirect_url || '/reservas/mis-turnos/';
                        }, 1500);
                    } else {
                        mostrarAlerta(data.error || 'Error al procesar la reserva', 'error');
                        submitBtn.innerHTML = originalBtnText;
                        submitBtn.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    if (error.message === 'SESSION_EXPIRED') {
                        mostrarAlerta('Su sesión ha expirado. Por favor, inicie sesión nuevamente.', 'warning');
                        setTimeout(() => {
                            window.location.href = '/auth/login/';
                        }, 2000);
                    } else {
                        mostrarAlerta('Error al procesar la reserva: ' + error.message, 'error');
                        submitBtn.innerHTML = originalBtnText;
                        submitBtn.disabled = false;
                    }
                });
            });
        }
        
        // Funciones auxiliares
        
        // Funciones auxiliares
        function formatDate(dateString) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            // Aseguramos que se use la fecha seleccionada y no la actual
            // El formato de dateString es YYYY-MM-DD
            if (!dateString) return '';
            
            // Crear la fecha correctamente a partir del string YYYY-MM-DD
            const [year, month, day] = dateString.split('-');
            const date = new Date(year, month - 1, day);
            return date.toLocaleDateString('es-ES', options);
        }
        
        function formatDateValue(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return year + '-' + month + '-' + day;
        }
        
        function mostrarAlerta(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-' + type + ' alert-dismissible fade show';
            alertDiv.role = 'alert';
            alertDiv.innerHTML = message + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
            
            const cardBody = document.querySelector('.card-body');
            cardBody.insertBefore(alertDiv, cardBody.firstChild);
            
            // Auto dismiss after 5 seconds
            setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => alertDiv.remove(), 150);
            }, 5000);
        }
        
        // Alias para compatibilidad
        const showAlert = mostrarAlerta;
        
        // Inicializar el modal de redención de puntos
        const redimirPuntosModal = document.getElementById('redimirPuntosModal');
        if (redimirPuntosModal) {
            const recompensaSelect = document.getElementById('recompensaSelect');
            const puntosRedimir = document.getElementById('puntosRedimir');
            const puntosDisponibles = document.getElementById('puntosDisponibles');
            const alertaPuntos = document.getElementById('alertaPuntos');
            const btnConfirmarRecompensa = document.getElementById('btnConfirmarRecompensa');
            
            // Cargar los puntos disponibles del cliente cuando se abre el modal
            if (redimirPuntosModal) {
                redimirPuntosModal.addEventListener('show.bs.modal', function() {
                    // Obtener los puntos disponibles del cliente desde el valor ya establecido en el input
                    const puntosClienteDisponibles = parseInt(puntosDisponibles.value) || 0;
                    
                    // Mostrar en consola para depuración
                    console.log('Puntos disponibles:', puntosClienteDisponibles);
                    
                    // Resetear la selección
                    recompensaSelect.selectedIndex = 0;
                    puntosRedimir.value = '';
                    alertaPuntos.style.display = 'none';
                    btnConfirmarRecompensa.disabled = true;
                });
            }
            
            if (recompensaSelect) {
                recompensaSelect.addEventListener('change', function() {
                const selectedOption = recompensaSelect.options[recompensaSelect.selectedIndex];
                const puntos = selectedOption.dataset.puntos;
                puntosRedimir.value = puntos;
                
                // Mostrar en consola para depuración
                console.log('Recompensa seleccionada:', selectedOption.textContent);
                console.log('Puntos necesarios:', puntos);
                console.log('Puntos disponibles:', puntosDisponibles.value);
                
                // Verificar si tiene suficientes puntos
                if (parseInt(puntos) > parseInt(puntosDisponibles.value)) {
                    console.log('No tiene suficientes puntos');
                    alertaPuntos.style.display = 'block';
                    btnConfirmarRecompensa.disabled = true;
                } else {
                    console.log('Tiene suficientes puntos');
                    alertaPuntos.style.display = 'none';
                    btnConfirmarRecompensa.disabled = false;
                }
            });
            }
            
            // Manejar la confirmación de recompensa
            if (btnConfirmarRecompensa) {
                btnConfirmarRecompensa.addEventListener('click', function() {
                const selectedOption = recompensaSelect.options[recompensaSelect.selectedIndex];
                const puntos = parseInt(selectedOption.dataset.puntos);
                const recompensaValor = selectedOption.value;
                const recompensaNombre = selectedOption.textContent;
                
                // Actualizar campos ocultos
                document.getElementById('usarPuntos').value = 'true';
                document.getElementById('puntosARedimir').value = puntos;
                document.getElementById('recompensaSeleccionada').value = recompensaValor;
                
                // Calcular descuento según la recompensa seleccionada
                let descuento = 0;
                if (selectedService) {
                    const precioServicio = servicePrices[selectedService];
                    const puntosDisponiblesCliente = parseInt(puntosDisponibles.value);
                    const resultado = calcularDescuentoPorPuntos(puntosDisponiblesCliente, precioServicio, recompensaValor);
                    
                    descuento = resultado.descuento;
                    puntosUsados = resultado.puntosUsados;
                    document.getElementById('descuentoAplicado').value = descuento;
                    document.getElementById('puntosARedimir').value = puntosUsados;
                    precioFinalConDescuento = resultado.precioFinal;
                    
                    // Mostrar mensaje con el descuento aplicado
                    const medioPagoSeleccionadoDiv = document.querySelector('#medioPagoSeleccionado');
                    if (medioPagoSeleccionadoDiv) {
                        medioPagoSeleccionadoDiv.style.display = 'block';
                        medioPagoSeleccionadoDiv.innerHTML = `
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i> 
                                <strong>¡Recompensa seleccionada!</strong> ${recompensaNombre} por ${puntosUsados} puntos.
                                ${precioFinalConDescuento === 0 ? '<br><strong>¡Tu servicio será completamente gratis!</strong>' : '<br>Descuento: $' + descuento.toLocaleString() + '<br>Precio final: $' + precioFinalConDescuento.toLocaleString()}
                            </div>
                        `;
                    }
                }
                
                // Cerrar el modal
                const modalInstance = bootstrap.Modal.getInstance(redimirPuntosModal);
                modalInstance.hide();
            });
            }
        }
    });
</script>
{% endblock %}