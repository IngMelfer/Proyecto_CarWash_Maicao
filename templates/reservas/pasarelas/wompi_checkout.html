{% extends 'base.html' %}
{% load static %}

{% block title %}Pago con Wompi - {{ block.super }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Pago con Wompi</h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <p><strong>Reserva:</strong> {{ reserva.servicio.nombre }}</p>
                        <p><strong>Fecha y hora:</strong> {{ reserva.fecha_hora|date:"d/m/Y H:i" }}</p>
                        <p><strong>Precio Original:</strong> ${{ reserva.servicio.precio|floatformat:0 }}</p>
                        {% if descuento_aplicado > 0 %}
                        <p><strong>Descuento por Puntos:</strong> <span class="text-success">-${{ descuento_aplicado|floatformat:0 }}</span></p>
                        <p><strong>Puntos Redimidos:</strong> <span class="text-primary">{{ puntos_a_redimir }} puntos</span></p>
                        {% endif %}
                        <p><strong>Monto a pagar:</strong> ${{ monto|floatformat:0 }}</p>
                        <p><strong>Referencia:</strong> {{ referencia }}</p>
                    </div>
                    
                    <div class="text-center mb-4">
                        <img src="{% static 'img/wompi_logo.png' %}" alt="Wompi" class="img-fluid" style="max-height: 60px;">
                    </div>
                    
                    <div id="payment-form" class="text-center">
                        <p>Serás redirigido a la pasarela de pago segura de Wompi.</p>
                        <button id="checkout-button" class="btn btn-primary btn-lg">Continuar al pago</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.wompi.co/widget.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const checkoutButton = document.getElementById('checkout-button');
        
        checkoutButton.addEventListener('click', function() {
            const wompiCheckout = new WidgetCheckout({
                currency: 'COP',
                amountInCents: {{ monto }} * 100,
                reference: '{{ referencia }}',
                publicKey: '{{ public_key }}',
                redirectUrl: '{{ redirect_url }}',
                taxInCents: {
                    vat: 0,
                    consumption: 0
                },
                customerData: {
                    email: '{{ reserva.cliente.user.email }}',
                    fullName: '{{ reserva.cliente.user.get_full_name }}',
                    phoneNumber: '{{ reserva.cliente.telefono }}',
                    phoneNumberPrefix: '+57',
                    legalId: '{{ reserva.cliente.documento }}',
                    legalIdType: 'CC'
                },
                shippingAddress: {
                    addressLine1: 'N/A',
                    city: 'N/A',
                    phoneNumber: '{{ reserva.cliente.telefono }}',
                    region: 'N/A',
                    country: 'CO'
                }
            });
            
            wompiCheckout.open(function(result) {
                const transaction = result.transaction;
                console.log('Transaction ID: ' + transaction.id);
                console.log('Transaction Status: ' + transaction.status);
                
                // Redirigir a la página de confirmación
                window.location.href = '{{ redirect_url }}?id=' + transaction.id;
            });
        });
    });
</script>
{% endblock %}