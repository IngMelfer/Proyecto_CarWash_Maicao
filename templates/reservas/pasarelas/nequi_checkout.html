{% extends 'base.html' %}

{% block title %}Procesando Pago con Nequi{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Procesando Pago con Nequi</h4>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <img src="/static/img/logo-nequi.svg" alt="Nequi Logo" class="img-fluid" style="max-height: 80px; width: auto; min-width: 150px;">
                    </div>
                    
                    {% if error_pago %}
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i> 
                        <strong>Error en el pago:</strong> {{ mensaje_error }}
                    </div>
                    <div class="text-center">
                        <a href="{% url 'reservas:reservar_turno' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i> Volver a intentar
                        </a>
                    </div>
                    {% elif pago_enviado %}
                    <div class="alert alert-success">
                        <i class="fas fa-mobile-alt me-2"></i> 
                        <strong>¡Pago enviado!</strong> {{ mensaje_exito }}
                    </div>
                    
                    <div class="alert alert-info">
                        <p class="mb-2"><i class="fas fa-info-circle me-2"></i> <strong>Instrucciones:</strong></p>
                        <ol class="mb-0">
                            <li>Revisa tu teléfono <strong>{{ telefono_nequi }}</strong></li>
                            <li>Abre la notificación de Nequi</li>
                            <li>Confirma el pago por <strong>${{ monto|floatformat:0 }}</strong></li>
                            <li>Regresa a esta página para continuar</li>
                        </ol>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <p class="mb-0"><i class="fas fa-info-circle me-2"></i> <strong>Preparando pago:</strong> Conectando con Nequi...</p>
                    </div>
                    {% endif %}
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5>Detalles de la Reserva:</h5>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Servicio:
                                    <span class="fw-bold">{{ reserva.servicio.nombre }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Fecha y Hora:
                                    <span class="fw-bold">{{ reserva.fecha_hora|date:"d/m/Y H:i" }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Bahía:
                                    <span class="fw-bold">{{ reserva.bahia.nombre }}</span>
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h5>Detalles del Pago:</h5>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Precio Original:
                                    <span class="fw-bold">${{ reserva.servicio.precio|floatformat:0 }}</span>
                                </li>
                                {% if descuento_aplicado > 0 %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Recompensa Aplicada:
                                    <span class="fw-bold text-success">{{ recompensa_seleccionada }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Descuento por Puntos:
                                    <span class="fw-bold text-success">-${{ descuento_aplicado|floatformat:0 }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Puntos Redimidos:
                                    <span class="fw-bold text-primary">{{ puntos_a_redimir }} puntos</span>
                                </li>
                                {% endif %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Monto a Pagar:
                                    <span class="fw-bold">${{ monto|floatformat:0 }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Referencia:
                                    <span class="fw-bold">{{ referencia }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Medio de Pago:
                                    <span class="fw-bold">{{ medio_pago.nombre }}</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    {% if pago_enviado %}
                    <div class="text-center mb-4">
                        <div id="statusContainer">
                            <div class="spinner-border text-primary me-2" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <span id="statusMessage">Esperando confirmación del pago...</span>
                        </div>
                        
                        <div id="successMessage" class="alert alert-success mt-3" style="display: none;">
                            <i class="fas fa-check-circle me-2"></i> ¡Pago confirmado exitosamente!
                        </div>
                        
                        <div id="errorMessage" class="alert alert-danger mt-3" style="display: none;">
                            <i class="fas fa-times-circle me-2"></i> El pago fue rechazado o cancelado.
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button id="checkStatusButton" class="btn btn-outline-primary me-2">
                            <i class="fas fa-sync-alt me-2"></i> Verificar Estado
                        </button>
                        <a href="{% url 'reservas:confirmar_pago' reserva.id %}" id="continueButton" class="btn btn-primary" style="display: none;">
                            Continuar <i class="fas fa-arrow-right ms-2"></i>
                        </a>
                        <a href="{% url 'reservas:reservar_turno' %}" id="retryButton" class="btn btn-secondary" style="display: none;">
                            <i class="fas fa-redo me-2"></i> Intentar de nuevo
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    {% if pago_enviado %}
    const transactionId = '{{ transaction_id }}';
    const statusContainer = document.getElementById('statusContainer');
    const statusMessage = document.getElementById('statusMessage');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');
    const continueButton = document.getElementById('continueButton');
    const retryButton = document.getElementById('retryButton');
    const checkStatusButton = document.getElementById('checkStatusButton');
    
    let checkInterval;
    let checkCount = 0;
    const maxChecks = 60; // Máximo 5 minutos (60 checks cada 5 segundos)
    
    function checkPaymentStatus() {
        fetch(`/reservas/nequi/status/?transaction_id=${transactionId}`)
            .then(response => response.json())
            .then(data => {
                checkCount++;
                
                if (data.success) {
                    const status = data.status;
                    
                    if (status === 'APPROVED' || status === 'SUCCESS') {
                        // Pago exitoso
                        clearInterval(checkInterval);
                        statusContainer.style.display = 'none';
                        successMessage.style.display = 'block';
                        continueButton.style.display = 'inline-block';
                        checkStatusButton.style.display = 'none';
                        
                        // Redirección automática después de 3 segundos
                        setTimeout(function() {
                            window.location.href = "{% url 'reservas:confirmar_pago' reserva.id %}";
                        }, 3000);
                        
                    } else if (status === 'REJECTED' || status === 'FAILED') {
                        // Pago rechazado
                        clearInterval(checkInterval);
                        statusContainer.style.display = 'none';
                        errorMessage.style.display = 'block';
                        retryButton.style.display = 'inline-block';
                        checkStatusButton.style.display = 'none';
                        
                    } else if (status === 'PENDING') {
                        // Pago pendiente, continuar verificando
                        statusMessage.textContent = 'Pago pendiente, esperando confirmación...';
                        
                    } else {
                        // Estado desconocido
                        statusMessage.textContent = `Estado: ${status}`;
                    }
                } else {
                    console.error('Error al verificar estado:', data.error);
                    statusMessage.textContent = 'Error al verificar el estado del pago';
                }
                
                // Detener verificación después del máximo de intentos
                if (checkCount >= maxChecks) {
                    clearInterval(checkInterval);
                    statusMessage.textContent = 'Tiempo de espera agotado. Verifica manualmente el estado.';
                    checkStatusButton.style.display = 'inline-block';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                statusMessage.textContent = 'Error de conexión al verificar el pago';
            });
    }
    
    // Verificar estado automáticamente cada 5 segundos
    checkInterval = setInterval(checkPaymentStatus, 5000);
    
    // Verificar estado inmediatamente
    checkPaymentStatus();
    
    // Botón para verificar manualmente
    checkStatusButton.addEventListener('click', function() {
        checkCount = 0; // Reiniciar contador
        checkPaymentStatus();
        
        // Reiniciar verificación automática
        clearInterval(checkInterval);
        checkInterval = setInterval(checkPaymentStatus, 5000);
    });
    
    {% endif %}
});
</script>
{% endblock %}