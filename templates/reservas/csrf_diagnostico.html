{% extends 'base.html' %}

{% block title %}Diagnóstico CSRF - Premium Car Detailing{% endblock %}

{% block extra_css %}
<style>
    .diagnostic-card {
        margin-bottom: 1.5rem;
    }
    .status-ok {
        color: #28a745;
    }
    .status-warning {
        color: #ffc107;
    }
    .status-error {
        color: #dc3545;
    }
    .code-block {
        background-color: #f8f9fa;
        border: 1px solid #eaecef;
        border-radius: 3px;
        padding: 1rem;
        margin: 1rem 0;
        font-family: monospace;
        white-space: pre-wrap;
        word-break: break-all;
    }
    .test-form {
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <h1 class="mb-4">Diagnóstico de Problemas CSRF</h1>
            
            <div class="alert alert-info">
                <p><strong>Instrucciones:</strong></p>
                <p>Esta página ayuda a diagnosticar y resolver problemas con la verificación CSRF en la aplicación.</p>
                <p>1. Revise el estado de las cookies y tokens CSRF.</p>
                <p>2. Pruebe los formularios para verificar si funcionan correctamente.</p>
                <p>3. Si encuentra problemas, utilice las soluciones recomendadas.</p>
            </div>
            
            <!-- Estado actual -->
            <div class="card diagnostic-card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Estado Actual</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h4>Información del Navegador</h4>
                            <ul class="list-group mb-3">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    User Agent
                                    <span id="user-agent">Cargando...</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Cookies Habilitadas
                                    <span id="cookies-enabled">Verificando...</span>
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h4>Estado CSRF</h4>
                            <ul class="list-group">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Cookie CSRF
                                    <span id="csrf-cookie-status">Verificando...</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Formularios con Token CSRF
                                    <span id="csrf-forms-status">Verificando...</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h4>Cookies Actuales</h4>
                        <div id="cookies-list" class="code-block">Cargando...</div>
                    </div>
                </div>
            </div>
            
            <!-- Pruebas -->
            <div class="card diagnostic-card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Pruebas CSRF</h3>
                </div>
                <div class="card-body">
                    <div class="test-form">
                        <h4>Prueba de Formulario POST</h4>
                        <form id="test-form" method="post" action="{% url 'reservas:csrf_test' %}">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="test-input" class="form-label">Mensaje de prueba</label>
                                <input type="text" class="form-control" id="test-input" name="test_message" value="Mensaje de prueba CSRF">
                            </div>
                            <button type="submit" class="btn btn-primary">Enviar Formulario</button>
                        </form>
                        <div id="form-result" class="mt-3"></div>
                    </div>
                    
                    <div class="test-form">
                        <h4>Prueba de AJAX</h4>
                        <div class="mb-3">
                            <button id="test-ajax" class="btn btn-info">Probar solicitud AJAX</button>
                        </div>
                        <div id="ajax-result" class="mt-3"></div>
                    </div>
                </div>
            </div>
            
            <!-- Soluciones -->
            <div class="card diagnostic-card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Soluciones Comunes</h3>
                </div>
                <div class="card-body">
                    <div class="accordion" id="solucionesAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingOne">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                    Cookie CSRF no encontrada
                                </button>
                            </h2>
                            <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#solucionesAccordion">
                                <div class="accordion-body">
                                    <p>Si la cookie CSRF no se encuentra:</p>
                                    <ol>
                                        <li>Asegúrese de que las cookies estén habilitadas en su navegador.</li>
                                        <li>Intente cerrar sesión y volver a iniciar sesión.</li>
                                        <li>Limpie las cookies del navegador y vuelva a cargar la página.</li>
                                        <li>Verifique que no esté usando un bloqueador de cookies.</li>
                                    </ol>
                                    <button id="regenerate-csrf" class="btn btn-warning">Regenerar Token CSRF</button>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingTwo">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                    Formularios sin token CSRF
                                </button>
                            </h2>
                            <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#solucionesAccordion">
                                <div class="accordion-body">
                                    <p>Si hay formularios sin token CSRF:</p>
                                    <ol>
                                        <li>Asegúrese de que todos los formularios POST incluyan la etiqueta <code>{% verbatim %}{% csrf_token %}{% endverbatim %}</code>.</li>
                                        <li>Verifique que el script csrf.js esté cargado correctamente.</li>
                                        <li>Intente recargar la página para regenerar los tokens.</li>
                                    </ol>
                                    <button id="fix-forms" class="btn btn-warning">Corregir Formularios</button>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingThree">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                    Errores en solicitudes AJAX
                                </button>
                            </h2>
                            <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#solucionesAccordion">
                                <div class="accordion-body">
                                    <p>Si las solicitudes AJAX fallan con errores CSRF:</p>
                                    <ol>
                                        <li>Asegúrese de que el encabezado X-CSRFToken se esté enviando con todas las solicitudes POST, PUT, DELETE.</li>
                                        <li>Verifique que la cookie CSRF esté presente y sea accesible por JavaScript.</li>
                                        <li>Compruebe que está utilizando las credenciales correctas en las solicitudes fetch/ajax.</li>
                                    </ol>
                                    <div class="code-block">
// Ejemplo de configuración correcta para fetch
fetch('/url/', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
    },
    credentials: 'same-origin',
    body: JSON.stringify(data)
});</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 text-center">
                <a href="{% url 'reservas:dashboard_admin' %}" class="btn btn-secondary">Volver al Dashboard</a>
                <button id="refresh-diagnostics" class="btn btn-primary ms-2">Actualizar Diagnóstico</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Función para obtener cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Función para mostrar todas las cookies
    function showCookies() {
        const cookiesDiv = document.getElementById('cookies-list');
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            let cookieText = '';
            cookies.forEach((cookie, index) => {
                cookieText += `${index + 1}. ${cookie.trim()}\n`;
            });
            cookiesDiv.textContent = cookieText;
        } else {
            cookiesDiv.textContent = 'No hay cookies disponibles';
            cookiesDiv.classList.add('status-error');
        }
    }
    
    // Función para verificar el estado CSRF
    function checkCSRFStatus() {
        // Verificar información del navegador
        document.getElementById('user-agent').textContent = navigator.userAgent;
        
        const cookiesEnabled = navigator.cookieEnabled;
        const cookiesEnabledEl = document.getElementById('cookies-enabled');
        cookiesEnabledEl.textContent = cookiesEnabled ? 'Sí' : 'No';
        cookiesEnabledEl.className = cookiesEnabled ? 'status-ok' : 'status-error';
        
        // Verificar cookie CSRF
        const csrfCookie = getCookie('csrftoken');
        const csrfCookieEl = document.getElementById('csrf-cookie-status');
        if (csrfCookie) {
            csrfCookieEl.textContent = `Presente (${csrfCookie.substring(0, 10)}...)`;
            csrfCookieEl.className = 'status-ok';
        } else {
            csrfCookieEl.textContent = 'NO ENCONTRADA';
            csrfCookieEl.className = 'status-error';
        }
        
        // Verificar formularios
        const forms = document.querySelectorAll('form[method="post"]');
        const formsWithCSRF = Array.from(forms).filter(form => 
            form.querySelector('input[name="csrfmiddlewaretoken"]')
        );
        
        const csrfFormsEl = document.getElementById('csrf-forms-status');
        if (forms.length === 0) {
            csrfFormsEl.textContent = 'No hay formularios POST';
            csrfFormsEl.className = 'status-warning';
        } else if (formsWithCSRF.length === forms.length) {
            csrfFormsEl.textContent = `${formsWithCSRF.length}/${forms.length} OK`;
            csrfFormsEl.className = 'status-ok';
        } else {
            csrfFormsEl.textContent = `${formsWithCSRF.length}/${forms.length} (¡Faltan tokens!)`;
            csrfFormsEl.className = 'status-error';
        }
        
        // Mostrar todas las cookies
        showCookies();
    }
    
    // Función para regenerar token CSRF
    function regenerateCSRFToken() {
        fetch('{% url "autenticacion:csrf_debug" %}', {
            method: 'GET',
            credentials: 'same-origin'
        })
        .then(response => {
            if (response.ok) {
                setTimeout(() => {
                    checkCSRFStatus();
                    alert('Token CSRF regenerado correctamente');
                }, 500);
            } else {
                alert('Error al regenerar token CSRF');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error de red al regenerar token CSRF');
        });
    }
    
    // Función para corregir formularios sin token CSRF
    function fixForms() {
        const forms = document.querySelectorAll('form[method="post"]');
        let fixed = 0;
        
        forms.forEach(form => {
            if (!form.querySelector('input[name="csrfmiddlewaretoken"]')) {
                const csrftoken = getCookie('csrftoken');
                if (csrftoken) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'csrfmiddlewaretoken';
                    input.value = csrftoken;
                    form.prepend(input);
                    fixed++;
                }
            }
        });
        
        checkCSRFStatus();
        alert(`${fixed} formularios corregidos`);
    }
    
    // Prueba de formulario
    document.getElementById('test-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const formResult = document.getElementById('form-result');
        formResult.innerHTML = '<div class="alert alert-secondary">Enviando formulario...</div>';
        
        const formData = new FormData(this);
        
        fetch(this.action, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            formResult.innerHTML = `<div class="alert alert-success">Éxito: ${JSON.stringify(data)}</div>`;
        })
        .catch(error => {
            formResult.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            console.error('Error:', error);
        });
    });
    
    // Prueba de AJAX
    document.getElementById('test-ajax').addEventListener('click', function() {
        const ajaxResult = document.getElementById('ajax-result');
        ajaxResult.innerHTML = '<div class="alert alert-secondary">Enviando solicitud AJAX...</div>';
        
        fetch('{% url "reservas:csrf_test" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin',
            body: JSON.stringify({ test: 'ajax' })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            ajaxResult.innerHTML = `<div class="alert alert-success">Éxito: ${JSON.stringify(data)}</div>`;
        })
        .catch(error => {
            ajaxResult.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            console.error('Error:', error);
        });
    });
    
    // Botones de acción
    document.getElementById('regenerate-csrf').addEventListener('click', regenerateCSRFToken);
    document.getElementById('fix-forms').addEventListener('click', fixForms);
    document.getElementById('refresh-diagnostics').addEventListener('click', checkCSRFStatus);
    
    // Iniciar verificación al cargar la página
    document.addEventListener('DOMContentLoaded', checkCSRFStatus);
</script>
{% endblock %}