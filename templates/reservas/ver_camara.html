{% extends 'base.html' %}

{% block title %}Ver Cámara - Premium Car Detailing{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'home' %}">Inicio</a></li>
                    {% if user.is_staff %}
                    <li class="breadcrumb-item"><a href="{% url 'reservas:dashboard_admin' %}">Dashboard</a></li>
                    {% else %}
                    <li class="breadcrumb-item"><a href="{% url 'reservas:mis_turnos' %}">Mis Turnos</a></li>
                    {% endif %}
                    <li class="breadcrumb-item active" aria-current="page">Ver Cámara</li>
                </ol>
            </nav>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Cámara en vivo - {{ bahia.nombre }}</h5>
                    <span class="badge bg-success" id="estado-camara">En línea</span>
                </div>
                <div class="card-body">
                    {% if bahia.tiene_camara and bahia.ip_camara %}
                        <div class="text-center mb-4">
                            <div class="ratio ratio-16x9 mb-3">
                                <iframe src="{{ camera_url }}" allowfullscreen id="camara-iframe" onerror="handleCameraError()"></iframe>
                                <div id="camera-error" class="d-none position-absolute top-0 start-0 w-100 h-100 bg-dark d-flex align-items-center justify-content-center text-white">
                                    <div class="text-center p-4">
                                        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                                        <h5>Error de conexión</h5>
                                        <p>No se puede conectar con la cámara en este momento.</p>
                                        <p class="small text-warning">Tipo de cámara: {{ bahia.get_tipo_camara_display }}</p>
                                        {% if user.is_staff %}
                                        <p class="small">Como administrador, puede seguir viendo esta página aunque el servicio haya finalizado.</p>
                                        <button class="btn btn-sm btn-outline-light" onclick="intentarReconectar()">Intentar reconectar</button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-info" id="mensaje-camara">
                                <i class="fas fa-info-circle me-2"></i> Visualizando el servicio en tiempo real
                                <span class="badge bg-secondary ms-2">{{ bahia.get_tipo_camara_display }}</span>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header bg-secondary text-white">
                                        <h6 class="mb-0">Detalles del Servicio</h6>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Servicio:</strong> {{ reserva.servicio.nombre }}</p>
                                        <p><strong>Fecha y Hora:</strong> {{ reserva.fecha_hora|date:"d/m/Y H:i" }}</p>
                                        <p><strong>Estado:</strong> {{ reserva.get_estado_display }}</p>
                                        <p><strong>Bahía:</strong> {{ bahia.nombre }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-secondary text-white">
                                        <h6 class="mb-0">Información del Vehículo</h6>
                                    </div>
                                    <div class="card-body">
                                        {% if vehiculo %}
                                            <p><strong>Tipo:</strong> {{ vehiculo.get_tipo_display }}</p>
                                            <p><strong>Marca y Modelo:</strong> {{ vehiculo.marca }} {{ vehiculo.modelo }}</p>
                                            <p><strong>Año:</strong> {{ vehiculo.anio }}</p>
                                            <p><strong>Placa:</strong> {{ vehiculo.placa }}</p>
                                        {% else %}
                                            <p class="text-muted">No hay información del vehículo disponible</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i> Esta bahía no tiene cámara configurada o no está disponible en este momento.
                        </div>
                    {% endif %}
                </div>
                <div class="card-footer">
                    {% if user.is_staff %}
                    <a href="{% url 'reservas:dashboard_admin' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i> Volver al Dashboard
                    </a>
                    {% else %}
                    <a href="{% url 'reservas:mis_turnos' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i> Volver a Mis Turnos
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Función para manejar errores de conexión con la cámara
    function handleCameraError() {
        const cameraError = document.getElementById('camera-error');
        if (cameraError) {
            cameraError.classList.remove('d-none');
        }
        
        const estadoCamara = document.getElementById('estado-camara');
        if (estadoCamara) {
            estadoCamara.textContent = 'Error de conexión';
            estadoCamara.classList.remove('bg-success');
            estadoCamara.classList.add('bg-danger');
        }
        
        const mensajeCamara = document.getElementById('mensaje-camara');
        if (mensajeCamara) {
            let mensaje = '<i class="fas fa-exclamation-triangle me-2"></i> ';
            mensaje += 'No se puede conectar con la cámara. ';
            
            // Agregar sugerencias específicas para DroidCam
            if (window.location.href.includes('droidcam') || '{{ bahia.ip_camara }}'.includes(':4747')) {
                mensaje += '<br><strong>Sugerencias para DroidCam:</strong><ul>';
                mensaje += '<li>Verifique que la aplicación DroidCam esté abierta en su dispositivo</li>';
                mensaje += '<li>Asegúrese de que el dispositivo y este servidor estén en la misma red WiFi</li>';
                mensaje += '<li>Compruebe que la dirección IP y puerto sean correctos</li>';
                mensaje += '</ul>';
                mensaje += '<button class="btn btn-sm btn-primary mt-2" onclick="intentarReconectar()">Intentar reconectar</button>';
            } else {
                mensaje += 'Por favor, intente más tarde o contacte al administrador.';
            }
            
            mensajeCamara.innerHTML = mensaje;
            mensajeCamara.classList.remove('alert-info');
            mensajeCamara.classList.add('alert-danger');
        }
    }
    
    // Función para intentar reconectar con la cámara
    function intentarReconectar() {
        const camaraIframe = document.getElementById('camara-iframe');
        const estadoCamara = document.getElementById('estado-camara');
        const mensajeCamara = document.getElementById('mensaje-camara');
        const cameraError = document.getElementById('camera-error');
        
        if (camaraIframe) {
            // Mostrar mensaje de reconexión
            if (mensajeCamara) {
                mensajeCamara.innerHTML = '<i class="fas fa-sync fa-spin me-2"></i> Intentando reconectar...';
                mensajeCamara.classList.remove('alert-danger');
                mensajeCamara.classList.add('alert-warning');
            }
            
            // Ocultar mensaje de error
            if (cameraError) {
                cameraError.classList.add('d-none');
            }
            
            // Cambiar estado
            if (estadoCamara) {
                estadoCamara.textContent = 'Reconectando...';
                estadoCamara.classList.remove('bg-danger');
                estadoCamara.classList.add('bg-warning');
            }
            
            // Recargar el iframe con un timestamp para evitar caché
            setTimeout(function() {
                let src = camaraIframe.src.split('?')[0]; // Eliminar parámetros anteriores
                camaraIframe.src = src + '?t=' + new Date().getTime();
            }, 1000);
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        const camaraIframe = document.getElementById('camara-iframe');
        const estadoCamara = document.getElementById('estado-camara');
        const mensajeCamara = document.getElementById('mensaje-camara');
        
        // Verificar si los elementos existen antes de continuar
        if (!camaraIframe || !estadoCamara || !mensajeCamara) {
            console.log('No se encontraron los elementos necesarios para la cámara');
            return; // Salir si alguno de los elementos no existe
        }
        
        // Verificar el estado de la cámara periódicamente
        function verificarEstadoCamara() {
            try {
                // Intentar acceder al contenido del iframe
                const iframeContent = camaraIframe.contentWindow || camaraIframe.contentDocument;
                
                // Si no podemos acceder, la cámara podría estar desconectada
                if (!iframeContent) {
                    handleCameraError();
                }
            } catch (error) {
                console.error('Error al verificar el estado de la cámara:', error);
                handleCameraError();
            }
        }
        
        // Verificar cada 15 segundos (más frecuente para DroidCam)
        const intervalId = setInterval(verificarEstadoCamara, 15000);
        
        // Guardar el ID del intervalo para poder limpiarlo si es necesario
        window.camaraIntervalId = intervalId;
        
        // Verificar después de cargar la página
        camaraIframe.onload = function() {
            // Restaurar estado normal si la carga es exitosa
            if (estadoCamara) {
                estadoCamara.textContent = 'En línea';
                estadoCamara.classList.remove('bg-danger', 'bg-warning');
                estadoCamara.classList.add('bg-success');
            }
            
            if (mensajeCamara) {
                mensajeCamara.innerHTML = '<i class="fas fa-info-circle me-2"></i> Visualizando el servicio en tiempo real';
                mensajeCamara.classList.remove('alert-danger', 'alert-warning');
                mensajeCamara.classList.add('alert-info');
            }
            
            const cameraError = document.getElementById('camera-error');
            if (cameraError) {
                cameraError.classList.add('d-none');
            }
            
            // Verificar estado después de cargar
            setTimeout(verificarEstadoCamara, 2000);
        };
        
        // Si hay error al cargar el iframe
        camaraIframe.onerror = function() {
            handleCameraError();
        };
        
        // Intentar reconectar la cámara si falla
        window.addEventListener('online', function() {
            intentarReconectar();
        });
        
        // Agregar botón de reconexión manual
        const cardFooter = document.querySelector('.card-footer');
        if (cardFooter) {
            const reconectarBtn = document.createElement('button');
            reconectarBtn.className = 'btn btn-info ms-2';
            reconectarBtn.innerHTML = '<i class="fas fa-sync me-2"></i> Reconectar cámara';
            reconectarBtn.onclick = intentarReconectar;
            cardFooter.appendChild(reconectarBtn);
        }
    });
</script>
{% endblock %}