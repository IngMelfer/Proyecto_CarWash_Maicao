{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard Público - CarWash Maicao{% endblock %}

{% block extra_css %}
<style>
    body {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #1e3c72 100%);
        background-attachment: fixed;
        color: #fff;
        font-family: 'Arial', sans-serif;
        margin: 0;
        padding: 0;
        min-height: 100vh;
        position: relative;
    }
    
    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: 
            radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.15) 0%, transparent 50%),
            radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.1) 0%, transparent 50%);
        pointer-events: none;
        z-index: -1;
    }
    .dashboard-header {
        background: linear-gradient(135deg, #2c5aa0 0%, #1e3c72 100%);
        color: white;
        padding: clamp(10px, 2vw, 15px) 0;
        margin-bottom: clamp(10px, 2vw, 15px);
        border-radius: 0;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
    }
    
    .dashboard-header h2 {
        font-size: clamp(1.2rem, 3vw, 2rem);
        margin-bottom: clamp(5px, 1vw, 10px);
    }
    
    .dashboard-header .clock {
        font-size: clamp(1rem, 2.5vw, 1.5rem);
        margin-bottom: clamp(3px, 0.8vw, 8px);
    }
    
    .dashboard-header p {
        font-size: clamp(0.8rem, 1.5vw, 1rem);
        margin-bottom: 0;
    }
    
    /* Mejoras en el espaciado del contenedor principal */
    .container-fluid {
        padding: 0 clamp(10px, 2vw, 20px);
        max-width: 100%;
        overflow-x: hidden;
    }
    
    /* Espaciado mejorado para elementos individuales */
    .reserva-placa {
        font-weight: bold;
        padding: clamp(2px, 0.5vw, 4px);
    }
    
    .tiempo-restante {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        padding: clamp(2px, 0.5vw, 4px);
        border-radius: 4px;
        background: rgba(0, 0, 0, 0.2);
    }
    
    /* Botones de control responsivos */
    .refresh-btn, .toggle-scroll-btn {
        position: fixed;
        width: clamp(45px, 8vw, 60px);
        height: clamp(45px, 8vw, 60px);
        font-size: clamp(1rem, 2vw, 1.5rem);
        border: none;
        border-radius: 50%;
        z-index: 1000;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    
    .refresh-btn {
        bottom: clamp(20px, 4vw, 30px);
        right: clamp(20px, 4vw, 30px);
    }
    
    .toggle-scroll-btn {
        bottom: clamp(80px, 12vw, 100px);
        right: clamp(20px, 4vw, 30px);
    }
    .airport-board {
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #fff;
        border-radius: 15px;
        overflow: hidden;
        margin-bottom: 15px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        height: clamp(400px, 70vh, calc(100vh - 220px));
        display: flex;
        flex-direction: column;
        max-width: 100%;
    }
    .board-header {
        background: linear-gradient(135deg, #2c5aa0 0%, #1e3c72 100%);
        color: white;
        padding: 15px 20px;
        font-size: clamp(0.8rem, 1.5vw, 1.1rem);
        font-weight: bold;
        display: grid;
        grid-template-columns: 
            minmax(60px, 1fr) 
            minmax(120px, 2fr) 
            minmax(100px, 1.5fr) 
            minmax(80px, 1fr) 
            minmax(60px, 0.8fr) 
            minmax(100px, 1.5fr) 
            minmax(80px, 1fr) 
            minmax(80px, 1fr) 
            minmax(100px, 1.2fr);
        align-items: center;
        gap: clamp(4px, 1vw, 8px);
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        text-align: center;
        overflow: hidden;
    }
    
    .board-content {
        padding: 0;
        flex-grow: 1;
        overflow-y: auto;
        overflow-x: auto;
        scroll-behavior: smooth;
    }
    
    /* Estilos responsivos para pantallas pequeñas */
    @media (max-width: 1200px) {
        .board-header {
            font-size: clamp(0.6rem, 1.2vw, 0.9rem);
            padding: 10px 15px;
        }
        
        .reserva-row {
            font-size: clamp(0.6rem, 1vw, 0.8rem);
            padding: clamp(6px, 1.5vw, 10px) clamp(8px, 2vw, 15px);
            min-height: clamp(35px, 6vw, 50px);
        }
    }
    
    @media (max-width: 768px) {
        .board-header {
            grid-template-columns: 
                minmax(50px, 0.8fr) 
                minmax(100px, 1.8fr) 
                minmax(80px, 1.2fr) 
                minmax(60px, 0.8fr) 
                minmax(50px, 0.6fr) 
                minmax(80px, 1.2fr) 
                minmax(60px, 0.8fr) 
                minmax(60px, 0.8fr) 
                minmax(80px, 1fr);
            font-size: clamp(0.5rem, 1vw, 0.7rem);
            padding: 8px 10px;
            gap: clamp(2px, 0.5vw, 4px);
        }
        
        .reserva-row {
            grid-template-columns: 
                minmax(50px, 0.8fr) 
                minmax(100px, 1.8fr) 
                minmax(80px, 1.2fr) 
                minmax(60px, 0.8fr) 
                minmax(50px, 0.6fr) 
                minmax(80px, 1.2fr) 
                minmax(60px, 0.8fr) 
                minmax(60px, 0.8fr) 
                minmax(80px, 1fr);
            font-size: clamp(0.5rem, 0.9vw, 0.7rem);
            padding: clamp(4px, 1vw, 8px) clamp(6px, 1.5vw, 10px);
            min-height: clamp(30px, 5vw, 40px);
            gap: clamp(2px, 0.5vw, 4px);
        }
        
        .airport-board {
            height: clamp(300px, 60vh, calc(100vh - 180px));
        }
    }
    
    @media (max-width: 480px) {
        .board-header span,
        .reserva-row > div {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .board-header {
            font-size: clamp(0.4rem, 0.8vw, 0.6rem);
            padding: 6px 8px;
        }
        
        .reserva-row {
            font-size: clamp(0.4rem, 0.7vw, 0.6rem);
            padding: clamp(3px, 0.8vw, 6px) clamp(4px, 1vw, 8px);
            min-height: clamp(25px, 4vw, 35px);
        }
    }
    .reserva-row {
        display: grid;
        grid-template-columns: 
            minmax(60px, 1fr) 
            minmax(120px, 2fr) 
            minmax(100px, 1.5fr) 
            minmax(80px, 1fr) 
            minmax(60px, 0.8fr) 
            minmax(100px, 1.5fr) 
            minmax(80px, 1fr) 
            minmax(80px, 1fr) 
            minmax(100px, 1.2fr);
        padding: clamp(8px, 2vw, 12px) clamp(10px, 3vw, 20px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        align-items: center;
        gap: clamp(4px, 1vw, 8px);
        transform: translateZ(0); /* Habilita aceleración por hardware */
        backdrop-filter: blur(5px);
        font-size: clamp(0.7rem, 1.2vw, 0.9rem);
        text-align: center;
        overflow: hidden;
        word-wrap: break-word;
        min-height: clamp(40px, 8vw, 60px);
    }
    .reserva-row:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 100, 255, 0.3);
        backdrop-filter: blur(10px);
    }
    .reserva-row.en-proceso {
        background-color: rgba(23, 162, 184, 0.2);
    }
    .reserva-row.pendiente {
        background-color: rgba(0, 0, 0, 0.8);
    }
    .reserva-row.completado {
        background-color: rgba(40, 167, 69, 0.1);
        color: #aaa;
    }
    .reserva-row.confirmado {
        background-color: rgba(255, 193, 7, 0.1);
    }
    .reserva-row.cancelado {
        background-color: rgba(220, 53, 69, 0.1);
        color: #aaa;
    }
    
    /* Estilos para reservas próximas y en hora */
    .reserva-row.proxima {
        background-color: rgba(255, 165, 0, 0.3) !important;
        border-left: 5px solid #ffa500;
        animation: proximaAlert 2s infinite;
    }
    
    .reserva-row.en-hora {
        background-color: rgba(255, 0, 0, 0.4) !important;
        border-left: 5px solid #ff0000;
        animation: enHoraAlert 1s infinite;
        box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
    }
    
    /* Efecto TERMINADA antes de desaparecer */
    .reserva-row.terminada {
        background-color: rgba(0, 255, 0, 0.6) !important;
        animation: terminadaEffect 3s ease-out forwards;
        position: relative;
        overflow: hidden;
    }
    
    .reserva-row.terminada::before {
        content: "TERMINADA";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 255, 0, 0.9);
        color: #000;
        padding: 10px 20px;
        border-radius: 10px;
        font-weight: bold;
        font-size: 1.5rem;
        z-index: 10;
        animation: terminadaText 3s ease-out;
    }
    
    .highlight-update {
        animation: highlight 2s ease;
    }
    
    @keyframes highlight {
        0% { background-color: rgba(255, 255, 0, 0.3); }
        100% { background-color: transparent; }
    }
    
    @keyframes proximaAlert {
        0%, 100% { 
            background-color: rgba(255, 165, 0, 0.3);
            transform: scale(1);
        }
        50% { 
            background-color: rgba(255, 165, 0, 0.6);
            transform: scale(1.02);
        }
    }
    
    @keyframes enHoraAlert {
        0%, 100% { 
            background-color: rgba(255, 0, 0, 0.4);
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
        }
        50% { 
            background-color: rgba(255, 0, 0, 0.8);
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.8);
        }
    }
    
    @keyframes terminadaEffect {
        0% { 
            opacity: 1;
            transform: scale(1);
        }
        70% { 
            opacity: 1;
            transform: scale(1.05);
        }
        100% { 
            opacity: 0;
            transform: scale(0.8);
            height: 0;
            padding: 0;
            margin: 0;
        }
    }
    
    @keyframes terminadaText {
        0% { 
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.5);
        }
        20% { 
            opacity: 1;
            transform: translate(-50%, -50%) scale(1.2);
        }
        80% { 
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        100% { 
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.8);
        }
    }
    .reserva-hora {
        font-size: 1.5rem;
        font-weight: bold;
        width: 100px;
        text-align: center;
        font-family: 'Courier New', monospace;
        color: #ffcc00;
    }
    .reserva-info {
        flex-grow: 1;
        padding: 0 15px;
    }
    .reserva-servicio {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 5px;
        color: #fff;
    }
    .reserva-vehiculo {
        font-size: 1rem;
        color: #ccc;
    }
    .reserva-bahia {
        width: 120px;
        text-align: center;
        font-size: 1.2rem;
        font-weight: bold;
        padding: 5px;
        border-radius: 4px;
        background-color: #003366;
        margin: 0 10px;
    }
    .reserva-estado {
        width: 120px;
        text-align: center;
        padding: 5px 10px;
        border-radius: 20px;
        font-weight: 500;
        margin-left: 10px;
    }
    .estado-pendiente {
        background-color: #ffc107;
        color: #212529;
    }
    .estado-en-proceso {
        background-color: #17a2b8;
        color: white;
        animation: pulsate 2s infinite;
        transition: all 0.3s ease;
    }
    .estado-completado {
        background-color: #28a745;
        color: white;
        transition: all 0.3s ease;
    }
    .estado-confirmado {
        background-color: #fd7e14;
        color: white;
        transition: all 0.3s ease;
    }
    .estado-cancelado {
        background-color: #dc3545;
        color: white;
        transition: all 0.3s ease;
    }
    .clock {
        font-size: 2.5rem;
        font-weight: bold;
        font-family: 'Courier New', monospace;
        color: #ffcc00;
        margin: 5px 0;
    }
    .refresh-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
    }
    .toggle-scroll-btn {
        position: fixed;
        bottom: 20px;
        right: 90px;
        z-index: 1000;
    }
    .sin-reservas {
        text-align: center;
        padding: 60px 30px;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        margin-top: 30px;
        color: #e0e0e0;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .sin-reservas h3 {
        margin-bottom: 15px;
        color: #fff;
        font-size: 1.5rem;
    }
    
    .sin-reservas p {
        font-size: 1.1rem;
        opacity: 0.8;
    }
    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: clamp(10px, 2vw, 20px);
        margin-bottom: clamp(15px, 3vw, 25px);
        padding: 0 clamp(10px, 2vw, 20px);
    }
    
    .stat-box {
        text-align: center;
        padding: clamp(15px, 3vw, 25px);
        border-radius: 15px;
        color: white;
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .stat-box::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
        pointer-events: none;
    }
    
    .stat-box:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
    }
    
    .stat-box h5 {
        margin-bottom: clamp(8px, 1.5vw, 15px);
        font-size: clamp(0.8rem, 1.5vw, 1.1rem);
        font-weight: bold;
        position: relative;
        z-index: 1;
    }
    
    .stat-box .stat-value {
        font-size: clamp(1.5rem, 4vw, 2.5rem);
        font-weight: bold;
        position: relative;
        z-index: 1;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    /* Responsive adjustments for stats */
    @media (max-width: 768px) {
        .stats-container {
            grid-template-columns: repeat(2, 1fr);
            gap: clamp(8px, 1.5vw, 15px);
            margin-bottom: clamp(10px, 2vw, 20px);
        }
        
        .stat-box {
            padding: clamp(10px, 2vw, 20px);
        }
    }
    
    @media (max-width: 480px) {
        .stats-container {
            grid-template-columns: repeat(2, 1fr);
            gap: clamp(5px, 1vw, 10px);
        }
        
        .stat-box h5 {
            font-size: clamp(0.6rem, 1.2vw, 0.9rem);
        }
        
        .stat-box .stat-value {
            font-size: clamp(1.2rem, 3vw, 2rem);
        }
    }
    .stat-total {
        background: linear-gradient(135deg, #2c5aa0 0%, #1e3c72 100%);
    }
    .stat-pendientes {
        background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%);
        color: #212529;
    }
    .stat-proceso {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
    }
    .stat-completados {
        background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
    }
    .stat-cancelados {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    }
    @keyframes pulsate {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }
    .lavador-info {
        font-style: italic;
        color: #aaa;
        font-size: 0.9rem;
        margin-left: 10px;
    }
    .duracion-info {
        background-color: #333;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.8rem;
        margin-left: 10px;
        display: inline-block;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header text-center">
    <div class="container-fluid">
        <h2 class="mb-2">Tablero de Turnos</h2>
        <div class="clock" id="reloj">00:00:00</div>
        <p class="mb-0 text-light">{{ reservas.0.fecha_hora|date:"l, j \d\e F \d\e Y"|title }}</p>
    </div>
</div>

<div class="container-fluid">
    <div class="stats-container">
        <div class="stat-box stat-total">
            <h5>Total Servicios</h5>
            <div class="stat-value">{{ total_servicios }}</div>
        </div>
        <div class="stat-box stat-pendientes">
            <h5>Confirmados</h5>
            <div class="stat-value">{{ confirmados }}</div>
        </div>
        <div class="stat-box stat-proceso">
            <h5>En Proceso</h5>
            <div class="stat-value">{{ en_proceso }}</div>
        </div>
        <div class="stat-box stat-completados">
            <h5>Completados</h5>
            <div class="stat-value">{{ completadas }}</div>
        </div>
        <div class="stat-box stat-cancelados">
            <h5>Cancelados</h5>
            <div class="stat-value">{{ cancelados }}</div>
        </div>
    </div>

    {% if reservas %}
        <div class="airport-board">
            <div class="board-header">
                <span>HORA</span>
                <span>SERVICIO</span>
                <span>VEHÍCULO</span>
                <span>PLACA</span>
                <span>DURACIÓN</span>
                <span>LAVADOR</span>
                <span>BAHÍA</span>
                <span>ESTADO</span>
                <span>TIEMPO RESTANTE</span>
            </div>
            <div class="board-content">
                {% for reserva in reservas %}
                    <div class="reserva-row {% if reserva.estado == 'pendiente' %}pendiente{% elif reserva.estado == 'en_proceso' %}en-proceso{% elif reserva.estado == 'completado' %}completado{% elif reserva.estado == 'confirmado' %}confirmado{% elif reserva.estado == 'cancelado' %}cancelado{% endif %}" data-reserva-id="{{ reserva.id }}" data-inicio="{{ reserva.fecha_hora|date:'Y-m-d H:i:s' }}" data-duracion="{{ reserva.servicio.duracion_minutos }}">
                        <div class="reserva-hora">{{ reserva.fecha_hora|time:"H:i" }}</div>
                        <div class="reserva-servicio">{{ reserva.servicio.nombre }}</div>
                        <div class="reserva-vehiculo">{{ reserva.vehiculo.marca }} {{ reserva.vehiculo.modelo }}</div>
                        <div class="reserva-placa" style="font-weight: bold;">{{ reserva.vehiculo.placa|default:"N/A" }}</div>
                        <div class="reserva-duracion">{{ reserva.servicio.duracion_minutos }} min</div>
                        <div class="reserva-lavador">{% if reserva.lavador %}{{ reserva.lavador.nombre_completo }}{% else %}Sin asignar{% endif %}</div>
                        <div class="reserva-bahia">{{ reserva.bahia.nombre }}</div>
                        <div class="reserva-estado 
                            {% if reserva.estado == 'pendiente' %}estado-pendiente
                            {% elif reserva.estado == 'en_proceso' %}estado-en-proceso
                            {% elif reserva.estado == 'completado' %}estado-completado
                            {% elif reserva.estado == 'confirmado' %}estado-confirmado
                            {% elif reserva.estado == 'cancelado' %}estado-cancelado{% endif %}">
                            {{ reserva.get_estado_display }}
                        </div>
                        <div class="tiempo-restante" id="tiempo-{{ reserva.id }}" style="font-family: monospace; font-weight: bold;">
                            {% if reserva.estado == 'en_proceso' %}--:--{% else %}-:-:-{% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% else %}
        <div class="sin-reservas">
            <h3>No hay servicios programados para hoy</h3>
            <p>Los servicios del día aparecerán en este panel automáticamente.</p>
        </div>
    {% endif %}
</div>

<button class="btn btn-primary btn-lg rounded-circle refresh-btn" onclick="actualizarDashboard()">
    <i class="fas fa-sync-alt"></i>
</button>

<button id="toggle-scroll" class="btn btn-info btn-lg rounded-circle toggle-scroll-btn" onclick="toggleAutoScroll()">
    <i class="fas fa-pause"></i>
</button>
{% endblock %}

{% block extra_js %}
<script>
    // Función para actualizar el reloj
    function actualizarReloj() {
        const ahora = new Date();
        const horas = ahora.getHours().toString().padStart(2, '0');
        const minutos = ahora.getMinutes().toString().padStart(2, '0');
        const segundos = ahora.getSeconds().toString().padStart(2, '0');
        document.getElementById('reloj').textContent = `${horas}:${minutos}:${segundos}`;
        
        // Verificar reservas próximas y en hora
        verificarReservasProximas();
        
        // Actualizar tiempo restante
        actualizarTiempoRestante();
    }

    // Función para calcular y actualizar el tiempo restante
    function actualizarTiempoRestante() {
        const ahora = new Date();
        
        document.querySelectorAll('.reserva-row').forEach(row => {
            const reservaId = row.getAttribute('data-reserva-id');
            const inicioStr = row.getAttribute('data-inicio');
            const duracionMinutos = parseInt(row.getAttribute('data-duracion'));
            const tiempoRestanteElement = document.getElementById(`tiempo-${reservaId}`);
            
            if (tiempoRestanteElement) {
                // Verificar si la reserva está "en proceso"
                const isEnProceso = row.classList.contains('en-proceso');
                
                if (isEnProceso && inicioStr && duracionMinutos) {
                    const inicioReserva = new Date(inicioStr);
                    const finReserva = new Date(inicioReserva.getTime() + (duracionMinutos * 60000));
                    
                    const tiempoRestanteMs = finReserva.getTime() - ahora.getTime();
                    
                    if (tiempoRestanteMs > 0) {
                        const minutosRestantes = Math.floor(tiempoRestanteMs / 60000);
                        const segundosRestantes = Math.floor((tiempoRestanteMs % 60000) / 1000);
                        
                        const tiempoFormateado = `${minutosRestantes.toString().padStart(2, '0')}:${segundosRestantes.toString().padStart(2, '0')}`;
                        tiempoRestanteElement.textContent = tiempoFormateado;
                        
                        // Cambiar color según el tiempo restante
                        if (minutosRestantes < 5) {
                            tiempoRestanteElement.style.color = '#ff4757'; // Rojo
                        } else {
                            tiempoRestanteElement.style.color = '#2ed573'; // Verde
                        }
                    } else {
                        tiempoRestanteElement.textContent = 'TERMINADO';
                        tiempoRestanteElement.style.color = '#ff4757'; // Rojo
                    }
                } else {
                    // Para todos los demás estados (pendiente, confirmado, completado, cancelado)
                    tiempoRestanteElement.textContent = '-:-:-';
                    tiempoRestanteElement.style.color = '#ffffff'; // Blanco
                }
            }
        });
    }

    // Función para verificar reservas próximas y en hora
    function verificarReservasProximas() {
        const ahora = new Date();
        const horaActual = ahora.getHours() * 60 + ahora.getMinutes(); // Minutos desde medianoche
        
        document.querySelectorAll('.reserva-row').forEach(row => {
            const horaTexto = row.querySelector('.reserva-hora').textContent;
            const [horas, minutos] = horaTexto.split(':').map(Number);
            const horaReserva = horas * 60 + minutos;
            
            // Calcular diferencia en minutos
            const diferencia = horaReserva - horaActual;
            
            // Remover clases anteriores
            row.classList.remove('proxima', 'en-hora');
            
            // Solo aplicar a reservas pendientes o confirmadas
            const estado = row.classList.contains('pendiente') || row.classList.contains('confirmado');
            
            if (estado) {
                if (diferencia <= 0 && diferencia >= -5) {
                    // Reserva en hora (hasta 5 minutos después)
                    row.classList.add('en-hora');
                } else if (diferencia > 0 && diferencia <= 15) {
                    // Reserva próxima (15 minutos antes)
                    row.classList.add('proxima');
                }
            }
        });
    }

    // Función para simular completar una reserva (para demostración)
    function simularCompletarReserva(reservaRow) {
        // Agregar clase terminada
        reservaRow.classList.add('terminada');
        
        // Después de 3 segundos, remover la reserva del DOM
        setTimeout(() => {
            reservaRow.style.display = 'none';
            // Actualizar contadores
            actualizarContadores();
        }, 3000);
    }

    // Función para actualizar contadores después de completar una reserva
    function actualizarContadores() {
        const totalVisible = document.querySelectorAll('.reserva-row:not([style*="display: none"])').length;
        const completadas = parseInt(document.querySelector('.stat-completados .stat-value').textContent) + 1;
        
        // Actualizar contadores en la interfaz
        document.querySelector('.stat-total .stat-value').textContent = totalVisible;
        document.querySelector('.stat-completados .stat-value').textContent = completadas;
        
        // Reducir contador de en proceso si la reserva estaba en proceso
        const enProceso = document.querySelectorAll('.reserva-row.en-proceso:not([style*="display: none"])').length;
        document.querySelector('.stat-proceso .stat-value').textContent = enProceso;
    }

    // Actualizar el reloj cada segundo
    setInterval(actualizarReloj, 1000);
    actualizarReloj(); // Inicializar el reloj

    // Función para hacer scroll automático a las reservas en proceso
    function scrollToEnProceso() {
        const enProcesoElements = document.querySelectorAll('.reserva-row.en-proceso');
        if (enProcesoElements.length > 0) {
            enProcesoElements[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    // Función para actualizar el contenido del dashboard sin recargar la página
    function actualizarDashboard() {
        fetch(window.location.href)
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Actualizar estadísticas
                const newStats = doc.querySelector('.stats-container');
                const currentStats = document.querySelector('.stats-container');
                if (newStats && currentStats) {
                    currentStats.innerHTML = newStats.innerHTML;
                }
                
                // Actualizar tablero de reservas
                const newBoard = doc.querySelector('.board-content');
                const currentBoard = document.querySelector('.board-content');
                if (newBoard && currentBoard) {
                    // Guardar la posición de desplazamiento actual
                    const scrollPosition = window.scrollY;
                    
                    // Detectar reservas que se completaron
                    const currentReservas = Array.from(currentBoard.querySelectorAll('.reserva-row'));
                    const newReservas = Array.from(newBoard.querySelectorAll('.reserva-row'));
                    
                    // Buscar reservas que cambiaron a completadas
                    currentReservas.forEach(currentRow => {
                        const horaActual = currentRow.querySelector('.reserva-hora').textContent;
                        const servicioActual = currentRow.querySelector('.reserva-servicio').textContent;
                        
                        // Buscar la misma reserva en el nuevo contenido
                        const newRow = newReservas.find(row => {
                            const horaNueva = row.querySelector('.reserva-hora').textContent;
                            const servicioNuevo = row.querySelector('.reserva-servicio').textContent;
                            return horaActual === horaNueva && servicioActual === servicioNuevo;
                        });
                        
                        // Si la reserva ya no está en el nuevo contenido (fue completada)
                        if (!newRow && !currentRow.classList.contains('terminada')) {
                            // Mostrar efecto TERMINADA
                            simularCompletarReserva(currentRow);
                            return; // No actualizar esta fila
                        }
                    });
                    
                    // Actualizar el contenido después de un pequeño delay para permitir animaciones
                    setTimeout(() => {
                        currentBoard.innerHTML = newBoard.innerHTML;
                        
                        // Restaurar la posición de desplazamiento
                        window.scrollTo(0, scrollPosition);
                        
                        // Verificar reservas próximas en el nuevo contenido
                        verificarReservasProximas();
                        
                        // Verificar si hay nuevas reservas en proceso
                        const enProcesoElements = document.querySelectorAll('.reserva-row.en-proceso');
                        if (enProcesoElements.length > 0) {
                            // Destacar brevemente las reservas en proceso
                            enProcesoElements.forEach(el => {
                                el.classList.add('highlight-update');
                                setTimeout(() => {
                                    el.classList.remove('highlight-update');
                                }, 2000);
                            });
                        }
                    }, 500);
                }
                
                // Verificar si hay mensaje de "sin reservas"
                const newEmptyMessage = doc.querySelector('.sin-reservas');
                const currentEmptyMessage = document.querySelector('.sin-reservas');
                const currentAirportBoard = document.querySelector('.airport-board');
                
                if (newEmptyMessage && !currentEmptyMessage) {
                    // Si ahora no hay reservas pero antes sí había
                    if (currentAirportBoard) {
                        currentAirportBoard.parentNode.replaceChild(newEmptyMessage.cloneNode(true), currentAirportBoard);
                    }
                } else if (!newEmptyMessage && currentEmptyMessage) {
                    // Si ahora hay reservas pero antes no había
                    const newAirportBoard = doc.querySelector('.airport-board');
                    if (newAirportBoard) {
                        currentEmptyMessage.parentNode.replaceChild(newAirportBoard.cloneNode(true), currentEmptyMessage);
                    }
                }
            })
            .catch(error => {
                console.error('Error al actualizar el dashboard:', error);
            });
    }

    // Ejecutar scroll inicial después de cargar la página
    window.addEventListener('load', function() {
        setTimeout(scrollToEnProceso, 1000);
        
        // Configurar actualización automática cada 30 segundos
        setInterval(actualizarDashboard, 30000);
    });

    // Auto-scroll suave para mostrar todas las reservas
    let autoScrollActive = true;
    let scrollDirection = 1; // 1 para abajo, -1 para arriba
    let scrollPosition = 0;
    let maxScrollPosition = 0;

    function toggleAutoScroll() {
        autoScrollActive = !autoScrollActive;
        const toggleBtn = document.getElementById('toggle-scroll');
        if (toggleBtn) {
            toggleBtn.innerHTML = autoScrollActive ? 
                '<i class="fas fa-pause"></i>' : 
                '<i class="fas fa-play"></i>';
        }
    }

    function autoScroll() {
        if (!autoScrollActive) return;
        
        const boardContent = document.querySelector('.board-content');
        if (!boardContent) return;
        
        maxScrollPosition = boardContent.scrollHeight - boardContent.clientHeight;
        
        // Si llegamos al final, cambiar dirección
        if (scrollPosition >= maxScrollPosition) {
            scrollDirection = -1;
        } else if (scrollPosition <= 0) {
            scrollDirection = 1;
        }
        
        scrollPosition += scrollDirection * 0.5; // Velocidad de desplazamiento
        scrollPosition = Math.max(0, Math.min(scrollPosition, maxScrollPosition));
        
        boardContent.scrollTop = scrollPosition;
    }

    // Iniciar auto-scroll cada 50ms para un movimiento suave
    setInterval(autoScroll, 50);
</script>
{% endblock %}