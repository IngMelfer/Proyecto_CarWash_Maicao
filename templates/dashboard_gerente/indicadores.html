{% extends 'base.html' %}
{% load reservas_filters %}

{% block title %}Indicadores - CarWash Maicao{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Indicadores</h2>
    <div class="btn-group">
      <a class="btn btn-outline-secondary" href="{% url 'dashboard_gerente:dashboard' %}">
        <i class="fas fa-arrow-left me-1"></i> Volver al Dashboard
      </a>
      <a class="btn btn-primary" href="{% url 'dashboard_gerente:kpis' %}">
        <i class="fas fa-sliders-h me-1"></i> Configurar KPIs
      </a>
    </div>
  </div>

  {% if kpis %}
    <p class="text-muted">Mostrando {{ kpis|length }} KPI(s) activos configurados por ti.</p>
  {% else %}
    <div class="alert alert-info">
      No tienes KPIs activos configurados. Usa el botón "Configurar KPIs" para crear indicadores.
    </div>
  {% endif %}

  <!-- Filtros avanzados -->
  <form class="card mb-4" method="get">
    <div class="card-body row g-3">
      <div class="col-12 col-md-3">
        <label class="form-label">Fecha inicio</label>
        <input type="date" class="form-control" name="fecha_inicio" value="{{ applied_filters.fecha_inicio }}">
      </div>
      <div class="col-12 col-md-3">
        <label class="form-label">Fecha fin</label>
        <input type="date" class="form-control" name="fecha_fin" value="{{ applied_filters.fecha_fin }}">
      </div>
      <div class="col-12 col-md-2">
        <select class="form-select" name="group_by" aria-label="Agrupar por">
          <option value="day" {% if applied_filters.group_by == 'day' %}selected{% endif %}>Día</option>
          <option value="week" {% if applied_filters.group_by == 'week' %}selected{% endif %}>Semana</option>
          <option value="month" {% if applied_filters.group_by == 'month' %}selected{% endif %}>Mes</option>
        </select>
      </div>
      <div class="col-12 col-md-2">
        <label class="form-label">Estado</label>
        <select class="form-select" name="estado">
          <option value="">Todos</option>
          {% for e in estado_choices %}
            <option value="{{ e.value }}" {% if applied_filters.estado == e.value %}selected{% endif %}>{{ e.label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12 col-md-2">
        <label class="form-label">Servicio</label>
        <select class="form-select" name="servicio">
          <option value="">Todos</option>
          {% for s in servicios %}
            <option value="{{ s.id }}" {% if applied_filters.servicio|default:'' == s.id|stringformat:'s' %}selected{% endif %}>{{ s.nombre }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="compararCheck" name="comparar" {% if applied_filters.comparar %}checked{% endif %}>
          <label class="form-check-label" for="compararCheck">Comparar con periodo anterior</label>
        </div>
      </div>
    </div>
    <div class="card-footer d-flex justify-content-end">
      <button class="btn btn-primary" type="submit"><i class="fas fa-filter me-1"></i> Aplicar filtros</button>
    </div>
  </form>

  <div class="row g-4">
    {% for chart in charts %}
      <div class="col-12 col-lg-6">
        <div class="card h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <strong>{{ chart.nombre }}</strong>
              <div class="small text-muted">{{ chart.entidad }} · {{ chart.metrica }} · Últimos {{ chart.periodo }} días</div>
            </div>
            <span class="badge bg-light text-dark">KPI #{{ forloop.counter }}</span>
          </div>
          <div class="card-body">
            <div class="position-relative">
              <canvas id="{{ chart.id }}" height="140"></canvas>
              <div class="position-absolute top-50 start-50 translate-middle text-center">
                <div class="fw-bold">
                  {% if chart.is_currency %}${{ chart.actual|format_price }}{% else %}{{ chart.actual|floatformat:0 }}{% endif %}
                </div>
                <div class="small text-muted">de {% if chart.is_currency %}${{ chart.max|format_price }}{% else %}{{ chart.max|floatformat:0 }}{% endif %}</div>
              </div>
            </div>
            <div class="d-flex justify-content-between mt-3 small">
              <div>Mínimo: <strong>{% if chart.is_currency %}${{ chart.min|format_price }}{% else %}{{ chart.min|floatformat:0 }}{% endif %}</strong></div>
              <div>Meta: <strong>{% if chart.is_currency %}${{ chart.meta|format_price }}{% else %}{{ chart.meta|floatformat:0 }}{% endif %}</strong></div>
              <div>Actual: <strong>{% if chart.is_currency %}${{ chart.actual|format_price }}{% else %}{{ chart.actual|floatformat:0 }}{% endif %}</strong></div>
            </div>
          </div>
        </div>
      </div>
    {% empty %}
      <div class="col-12">
        <div class="alert alert-warning">No hay datos para mostrar en los indicadores seleccionados.</div>
      </div>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Formateadores reutilizables
  function formatMiles(n, decimals = 0) {
    const sign = n < 0 ? '-' : '';
    const abs = Math.abs(Number(n) || 0);
    const fixed = abs.toFixed(decimals);
    const parts = fixed.split('.');
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    return sign + parts.join(decimals ? ',' : '');
  }
  const fmtPeso = (v) => '$' + formatMiles(v);

  document.addEventListener('DOMContentLoaded', function () {
    {% for chart in charts %}
      const ctx_{{ chart.id }} = document.getElementById('{{ chart.id }}').getContext('2d');
      const min_{{ chart.id }} = Number('{{ chart.min }}');
      const max_{{ chart.id }} = Number('{{ chart.max }}');
      const actual_{{ chart.id }} = Number('{{ chart.actual }}');
      const meta_{{ chart.id }} = Number('{{ chart.meta }}');
      const isCurrency_{{ chart.id }} = {{ chart.is_currency|yesno:'true,false' }};

      const range_{{ chart.id }} = Math.max(0, max_{{ chart.id }} - min_{{ chart.id }});
      const value_{{ chart.id }} = Math.max(0, Math.min(actual_{{ chart.id }} - min_{{ chart.id }}, range_{{ chart.id }}));
      const remaining_{{ chart.id }} = Math.max(0, range_{{ chart.id }} - value_{{ chart.id }});

      let color_{{ chart.id }} = '#e74a3b'; // rojo
      if (actual_{{ chart.id }} >= meta_{{ chart.id }}) {
        color_{{ chart.id }} = '#1cc88a'; // verde
      } else if (actual_{{ chart.id }} >= meta_{{ chart.id }} * 0.6) {
        color_{{ chart.id }} = '#f6c23e'; // amarillo
      }

      new Chart(ctx_{{ chart.id }}, {
        type: 'doughnut',
        data: {
          labels: ['Progreso', 'Restante'],
          datasets: [{
            data: [value_{{ chart.id }}, remaining_{{ chart.id }}],
            backgroundColor: [color_{{ chart.id }}, 'rgba(233,236,239,0.9)'],
            borderWidth: 0,
            hoverOffset: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          rotation: Math.PI,
          circumference: Math.PI,
          cutout: '70%',
          plugins: {
            legend: { display: false },
            tooltip: {
              enabled: true,
              callbacks: {
                label: (ctx) => {
                  const v = ctx.parsed;
                  const lbl = ctx.label;
                  const fmt = (n) => isCurrency_{{ chart.id }} ? fmtPeso(n) : formatMiles(n);
                  return `${lbl}: ${fmt(v)}`;
                }
              }
            }
          }
        }
      });
    {% endfor %}
  });
</script>
{% endblock %}